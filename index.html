<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Pandora的技术博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Pandora的技术博客">
<meta property="og:url" content="http://dama2716588.github.io/index.html">
<meta property="og:site_name" content="Pandora的技术博客">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Pandora的技术博客">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="Pandora的技术博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Pandora的技术博客</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://dama2716588.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-逆向Appstore应用（二）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/07/逆向Appstore应用（二）/" class="article-date">
  <time datetime="2016-09-07T12:27:43.000Z" itemprop="datePublished">2016-09-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/07/逆向Appstore应用（二）/">逆向Appstore应用（二）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="准备工作">准备工作</h3><p>代码签名 (code signing) 对一个App来讲至关重要，是iOS系统安全的重要组成部分，决定了App的哪些功能是被授权或者禁止的。尽管各种证书、配置文件等让初学这头痛不已，但确实给用户带来了极大的安全保障。</p>
<p>文件及环境：</p>
<ul>
<li>一个苹果的认证部门 Apple Worldwide Developer Relations CA颁发的Certificate</li>
<li>基于该Certificate生成的mobileprovision文件</li>
<li>系统环境 OSX 10.11.5</li>
</ul>
<h3 id="证书及文件">证书及文件</h3><h4 id="Certificate">Certificate</h4><p>Certificate是如何生成的呢？</p>
<p>首先需要开发者生成一个CertificateSigningRequest.certSigningRequest文件，具体步骤为钥匙串访问⟶证书助理⟶从证书颁发机构请求证书，按照提示填写相关信息，保存到磁盘即可。</p>
<p>等到CertificateSigningRequest.certSigningRequest后，通过   <code>openssl asn1parse -i -in CertificateSigningRequest.certSigningRequest</code>查看如下：</p>
<p><img src="http://7xkptx.com1.z0.glb.clouddn.com/f43h5j65k87k.png" alt=""></p>
<p>这个文件包含：<br>1，申请者信息<br>2，申请者公钥，此信息是申请者使用的私钥对应的公钥<br>3，摘要算法（SHA）和公钥加密算法（RSA）</p>
<p>此文件包含了我的信息，使用了sha1摘要算法和RSA公钥加密算法。苹果的Meber Center在拿到certSigningRequest文件后，将信息记录下来，并签发出相关的证书（Certificate），car证书包含哪些信息呢？又是如何使用certSigningRequest文件中的公钥呢？我们用openssl来看一下证书的内容：</p>
<p><code>openssl x509 -inform der -in ios_distribution.cer -noout -text</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: <span class="number">3</span> (<span class="number">0x2</span>)</span><br><span class="line">        Serial Number:</span><br><span class="line">            <span class="number">05</span>:<span class="number">33</span>:<span class="number">03</span>:<span class="number">2</span>c:<span class="number">57</span>:<span class="number">2</span>a:ad:<span class="number">6</span>c</span><br><span class="line">        Signature Algorithm: sha1WithRSAEncryption</span><br><span class="line">        Issuer: C=US, O=Apple Inc., OU=Apple Worldwide Developer Relations, CN=Apple Worldwide Developer Relations Certification Authority</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Jul <span class="number">10</span> <span class="number">07</span>:<span class="number">45</span>:<span class="number">50</span> <span class="number">2014</span> GMT</span><br><span class="line">            Not After : Jul  <span class="number">9</span> <span class="number">07</span>:<span class="number">45</span>:<span class="number">50</span> <span class="number">2017</span> GMT</span><br><span class="line">        Subject:......</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">            RSA Public Key: (<span class="number">2048</span> bit)</span><br><span class="line">                Modulus (<span class="number">2048</span> bit):</span><br><span class="line">    Signature Algorithm: sha1WithRSAEncryption</span><br><span class="line">        a8:b8:b5:ea:<span class="number">74</span>:e9:<span class="number">06</span>:d0:<span class="number">52</span>:<span class="number">90</span>:<span class="number">21</span>:<span class="number">10</span>:<span class="number">10</span>:f1:f6:ce:<span class="number">1</span>f:e7:</span><br><span class="line">        <span class="number">73</span>:<span class="number">08</span>:<span class="number">4</span>f:ca:<span class="number">02</span>:f8:<span class="number">73</span>:<span class="number">66</span>:<span class="number">06</span>:<span class="number">36</span>:<span class="number">48</span>:<span class="number">5</span>b:<span class="number">46</span>:<span class="number">7</span>d:ac:be:bd:c4:</span><br><span class="line">        ......</span><br><span class="line">        d5:<span class="number">46</span>:<span class="number">0</span>a:<span class="number">7</span>b</span><br></pre></td></tr></table></figure>
<p><code>Data</code>域即为证书的实际内容，与<code>Data</code>域平级的<code>Signature Algorithm</code>实际就是苹果的CA（Certificate Authority）的公钥，Data域包含我的苹果账号信息，其中最为重要的是我的公钥（Subject Public Key Info），这个公钥与我本机的私钥是对应的。当我们双击安装完证书后，<code>KeyChain会自动将这对密钥关联起来</code>，所以在KeyChain中可以看到类似的效果：</p>
<p><img src="http://7xkptx.com1.z0.glb.clouddn.com/vw3g54gd34f.png" alt=""></p>
<p><img src="http://7xkptx.com1.z0.glb.clouddn.com/ef3egfwergf3.png" alt=""></p>
<p>后续在程序上真机的过程中，会使用这个私钥，对代码进行签名，而公钥会附带在<code>mobileprovision</code>文件中，打包进app。那么mobileprovision又从哪里来？有什么作用呢？</p>
<h4 id="mobileprovision">mobileprovision</h4><p>首先来看一张图：</p>
<p><img src="http://7xkptx.com1.z0.glb.clouddn.com/fefegewr4f45f43f.png" alt=""></p>
<p>在Apple Developer Center通过之前生成的Certificate来生成mobileprovision配置文件，它将授权和沙盒联系了起来，可以用于让应用在你的开发设备上可以被运行和调试，也可以用于内部测试 (ad-hoc) 或者企业级应用的发布。配置文件并不是一个 plist 文件，它是一个根据密码讯息语法 (Cryptographic Message Syntax) 加密的文件（下文中会简称 CMS）。security 也可以解码这个 CMS 格式，那么我们就用 security 来看看一个 mobileprovision 文件内部是什么样子：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ security cms -D -i example<span class="variable">.mobileprovision</span></span><br></pre></td></tr></table></figure></p>
<p>你会得到一个 XML 格式的 plist 文件内容输出，DeveloperCertificates 这项，这一项是一个列表，包含了可以为使用这个配置文件的应用签名的所有证书。如果你用了一个不在这个列表中的证书进行签名，无论这个证书是否有效，这个应用都无法运行。ProvisionedDevices，在这一项里包含了所有可以用于测试的设备列表。因为配置文件需要被苹果签名，所以每次你添加了新的设备进去就要重新下载新的配置文件。具体如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span><br><span class="line">&lt;plist version="1.0"&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">  	&lt;key&gt;DeveloperCertificates&lt;/key&gt;</span><br><span class="line">       	&lt;array&gt;</span><br><span class="line">       		&lt;data&gt;MIIF0DCCBLi......Oo7Clog==&lt;/data&gt;</span><br><span class="line">        &lt;/array&gt;</span><br><span class="line">  &lt;key&gt;ProvisionsAllDevices&lt;/key&gt;</span><br><span class="line">  &lt;true/&gt;</span><br><span class="line">  &lt;key&gt;TeamIdentifier&lt;/key&gt;</span><br><span class="line">       	&lt;array&gt;</span><br><span class="line">       		&lt;string&gt;C789GLWV85&lt;/string&gt;</span><br><span class="line">       	&lt;/array&gt;</span><br><span class="line">  &lt;key&gt;Version&lt;/key&gt;</span><br><span class="line">       	&lt;integer&gt;1&lt;/integer&gt;</span><br><span class="line">&lt;/dict&gt;</span><br><span class="line">&lt;/plist&gt;</span><br></pre></td></tr></table></figure>
<p>所以，证书（及其对应的私钥）和配置文件（mobileprovision）是签名和打包的两个必要文件，如果要重新签名一个App，就需要在这两个上面动手脚了。</p>
<p>首先来了解一个已经签名了的App包含的内容，<code>$ codesign -vv -d Example.app</code> 会列出一些有关 <code>Example.app</code> 的签名信息：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Executable=/Users/pandora/Desktop/shell/gcdsample/Payload/GCDSample<span class="variable">.app</span>/GCDSample</span><br><span class="line">Identifier=com<span class="variable">.baidu</span><span class="variable">.GCDSample</span></span><br><span class="line">Format=app bundle with Mach-O universal (armv7 arm64)</span><br><span class="line">CodeDirectory v=<span class="number">20200</span> size=<span class="number">851</span> flags=<span class="number">0x0</span>(none) hashes=<span class="number">19</span>+<span class="number">5</span> location=embedded</span><br><span class="line">Signature size=<span class="number">4700</span></span><br><span class="line">Authority=iPhone Developer: 张三 (AFCH46B9XZ)</span><br><span class="line">Authority=Apple Worldwide Developer Relations Certification Authority</span><br><span class="line">Authority=Apple Root CA</span><br><span class="line">Signed Time=Jul <span class="number">18</span>, <span class="number">2016</span>, <span class="number">17</span>:<span class="number">23</span>:<span class="number">01</span></span><br><span class="line">Info<span class="variable">.plist</span> entries=<span class="number">26</span></span><br><span class="line">TeamIdentifier=RYRPKMVKDL</span><br><span class="line">Sealed Resources version=<span class="number">2</span> rules=<span class="number">12</span> files=<span class="number">7</span></span><br><span class="line">Internal requirements count=<span class="number">1</span> size=<span class="number">180</span></span><br></pre></td></tr></table></figure>
<p><code>Authority=iPhone Developer: 张三 (AFCH46B9XZ)</code>就是我的证书，iPhone Developer是标示开发使用，如果是发布证书的话则标示为 iPhone Distribution。是由<code>Apple Worldwide Developer Relations Certification Authority</code> 设置了签名，依此类推这个证书则是被 <code>Apple Root CA</code> 设置了签名。<code>Identifier</code> 是我在 Xcode 中设置的 bundle identifier。<code>TeamIdentifier</code> 用于标识我的工作组（系统会用这个来判断应用是否是由同一个开发者发布），可以通过私钥共享的方式将存储在keychain中的证书对应的私钥导出为p12文件，其他团队成员将此文件导入自己电脑，然后配合从member center下载对应的mobileprovision文件，就可以进行真机开发以及打包发布了。值得一提的是在新发布的Xcode8中新增了支持自动管理证书和自定义管理证书，自动管理证书将会根据你所选择的开发者账号自动为你处理配置文件和签名证书的设置，并且只在必要时进行提醒。这为开发者节省了不少时间和经历。</p>
<p>上面提到证书（及其对应的私钥）和配置文件（mobileprovision）是签名和打包的两个必要文件，那么，mobileprovision在哪里呢？</p>
<p>App在签名的过程中会在程序包中新建一个叫做<code>_CodeSignatue/CodeResources</code> 的文件，这个文件中存储了被签名的程序包中所有文件的签名。你可以自己去查看这个签名列表文件，它仅仅是一个 plist 格式文件。这个列表文件中不光包含了文件和它们的签名的列表，还包含了一系列规则，这些规则决定了哪些资源文件应当被设置签名。在 <code>CodeResources</code> 文件中会有4个不同区域，其中的 <code>rules</code> 和 <code>files</code> 是为老版本准备的，而 <code>files2</code> 和 <code>rules2</code>是为新的第二版的代码签名准备的。最主要的区别是在新版本中你无法再将某些资源文件排除在代码签名之外，在过去（OS X 10.9.5 之前）你是可以的，只要在被设置签名的程序包中添加一个名为 <code>ResourceRules.plist</code> 的文件，这个文件会规定哪些资源文件在检查代码签名是否完好时应该被忽略。但是在新版本的代码签名中，这种做法不再有效。所有的代码文件和资源文件都必须设置签名，不再可以有例外。在新版本的代码签名规定中，一个程序包中的可执行程序包，例如扩展 (extension)，是一个独立的需要设置签名的个体，在检查签名是否完整时应当被单独对待。</p>
<p>所以，比如微信这种多target的App，在做重签名的时候，不仅是主工程，还包括watch app及其他extension，都需要重新签名才可以。</p>
<p>以开源中国为例，先从Appstore下载ipa文件，首先执行<code>$ unzip oschina.ipa</code>，解压ipa包，进入Payload文件夹内，找到iosapp.app包，<code>$ codesign -vv -d oschina.app</code> 会列出一些有关 <code>Example.app</code> 的签名信息，通过<code>security</code>命令产看keychain中已经安装的证书文件<code>$ security find-identity -p codesigning</code>，显示结果如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Policy: Code Signing</span><br><span class="line">  Matching identities</span><br><span class="line">  <span class="number">1</span>) C552814957BC5691121564774AC86E036B9E2AEE <span class="string">"iPhone Developer: abc (WGDSKET7K5)"</span> (CSSMERR_TP_CERT_EXPIRED)</span><br><span class="line">  <span class="number">2</span>) <span class="number">630648</span>B3BF32E6D349EDE08C4517<span class="built_in">CAFA9B12FD6B</span> <span class="string">"iPhone Developer: def (UX59QF88DD)"</span> (CSSMERR_TP_CERT_EXPIRED)</span><br><span class="line">  </span><br><span class="line">  Valid identities only</span><br><span class="line">  <span class="number">1</span>) <span class="number">32</span>F000F9C845C6626E8E18919E58C386065C5D16 <span class="string">"iPhone Distribution: abc Co.,Ltd."</span></span><br><span class="line">  <span class="number">2</span>) <span class="number">38</span>A279804C22853C3F2575FD06BF26E225C08569 <span class="string">"iPhone Distribution: def Co., Ltd."</span></span><br></pre></td></tr></table></figure>
<p>Matching identities下显示所有已经安装的证书，Valid identities only代表当前可用的证书。</p>
<h3 id="真正的开始">真正的开始</h3><p>由于Appstore的的应用都是经过DRM加密的，如果想重签名App，需要将从Appstore下载的ipa文件解密，否则就算签名成功，安装成功，app还是会闪退。通过<a href="http://dama2716588.github.io/2016/07/20/%E9%80%86%E5%90%91Appstore%E5%BA%94%E7%94%A8%EF%BC%88%E4%B8%80%EF%BC%89/">逆向Appstore应用（一）</a>中的方法，可以拿到解密后开源中国iosapp.decrypted文件，替换Payload目录下ios.app内的名为iosapp的二进制文件，此时就可以得到解密后的iosapp.app文件了。在Payload目录下执行：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ codesign -s <span class="string">"iPhone Distribution: abc"</span> iosapp<span class="variable">.app</span></span><br></pre></td></tr></table></figure></p>
<p>提示：iosapp.app: is already signed，说明此app文件已经被签名过了，需要加上-f参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ codesign <span class="operator">-f</span> <span class="operator">-s</span> <span class="string">"iPhone Distribution: abc"</span> iosapp.app</span><br></pre></td></tr></table></figure>
<p>显示：iosapp.app: replacing existing signature，签名成功，执行<code>codesign -vv -d</code>查看签名信息如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">➜  Payload codesign -vv -d iosapp<span class="variable">.app</span></span><br><span class="line">Executable=/Users/pandora/Desktop/shell/oschina/Payload/iosapp<span class="variable">.app</span>/iosapp</span><br><span class="line">Identifier=net<span class="variable">.oschina</span><span class="variable">.iosapp</span></span><br><span class="line">Format=app bundle with Mach-O universal (armv7 arm64)</span><br><span class="line">CodeDirectory v=<span class="number">20200</span> size=<span class="number">64082</span> flags=<span class="number">0x0</span>(none) hashes=<span class="number">1997</span>+<span class="number">3</span> location=embedded</span><br><span class="line">Signature size=<span class="number">4758</span></span><br><span class="line">Authority=iPhone Distribution: abc.</span><br><span class="line">Authority=Apple Worldwide Developer Relations Certification Authority</span><br><span class="line">Authority=Apple Root CA</span><br><span class="line">Signed Time=Sep <span class="number">6</span>, <span class="number">2016</span>, <span class="number">18</span>:<span class="number">08</span>:<span class="number">09</span></span><br><span class="line">Info<span class="variable">.plist</span> entries=<span class="number">36</span></span><br><span class="line">TeamIdentifier=C789GLWV85</span><br><span class="line">Sealed Resources version=<span class="number">2</span> rules=<span class="number">12</span> files=<span class="number">473</span></span><br><span class="line">Internal requirements count=<span class="number">1</span> size=<span class="number">212</span></span><br></pre></td></tr></table></figure>
<p>然后，压缩已经签名的Payload文件夹为zip格式，然后修改zip为ipa格式即可得到解密后的ipa文件了。使用<a href="http://tui.tongbu.com/" target="_blank" rel="external">同步推</a>安装提示ApplicationVerificationFail，提示认证失败，这是因为配置文件（.mobileprovision）认证失败，决定了某一个应用是否能够在某一个特定的设备上运行，接下来需要给替换开源中国的mobileprovision文件。找到证书”iPhone Distribution: abc”对应的配置文件A.mobileprovision，修改名称为：embedded.mobileprovision，copy至iosapp.app包内，重新压缩转换为ipa文件，安装时依然提示：ApplicationVerificationFail。</p>
<p>这是因为缺少了entitlements文件，它决定了哪些系统资源在什么情况下允许被一个应用使用。简单的说它就是一个沙盒的配置列表，上面列出了哪些行为被允许，哪些会被拒绝，Xcode 会将这个文件作为 <code>--entitlements</code> 参数的内容传给 <code>codesign</code> 。在 Xcode 的 Capabilities 选项卡下选择一些选项之后， Xcode 会自动生成一个 <code>.entitlements</code> 文件，然后在需要的时候往里面添加条目。比如将应用添加进了一个 App Group (比如说为了与extensions 共享数据，<code>com.apple.security.application-groups</code>)， 或者开启了推送功能 (<code>aps-environment</code>)，如果有将它连接到调试器的需求，这就需要将 <code>get-task-allow</code> 设为 <code>true</code>等等。</p>
<p>可以通过如下命令查看entitlements文件：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codesign -d --entitlements - /Users/pandora/Desktop/shell/oschina/开源中国\ <span class="number">3.7</span>.1/Payload/iosapp<span class="variable">.app</span></span><br></pre></td></tr></table></figure></p>
<p>得到的信息如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span><br><span class="line">&lt;plist version="1.0"&gt;</span><br><span class="line">       	&lt;dict&gt;</span><br><span class="line">       		&lt;key&gt;keychain-access-groups&lt;/key&gt;</span><br><span class="line">       		&lt;array&gt;</span><br><span class="line">       			&lt;string&gt;WSUBE85MHP.net.oschina.iosapp&lt;/string&gt;</span><br><span class="line">       		&lt;/array&gt;</span><br><span class="line"></span><br><span class="line">       		&lt;key&gt;com.apple.developer.team-identifier&lt;/key&gt;</span><br><span class="line">       		&lt;string&gt;WSUBE85MHP&lt;/string&gt;</span><br><span class="line"></span><br><span class="line">       		&lt;key&gt;application-identifier&lt;/key&gt;</span><br><span class="line">       		&lt;string&gt;WSUBE85MHP.net.oschina.iosapp&lt;/string&gt;</span><br><span class="line"></span><br><span class="line">       	&lt;/dict&gt;</span><br><span class="line">&lt;/plist&gt;</span><br></pre></td></tr></table></figure>
<p>所以，重新签名一个app时，除了替换Certificate证书与mobileprovision配置文件外，还需要生成对应的entitlements.plist文件，分别执行以下两个命令：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ security cms -D -<span class="tag">i</span> <span class="string">"extracted/Payload/$APPLICATION/embedded.mobileprovision"</span> &gt; t_entitlements_full<span class="class">.plist</span></span><br><span class="line">$ /usr/libexec/PlistBuddy -x -c <span class="string">'Print:Entitlements'</span> t_entitlements_full<span class="class">.plist</span> &gt; t_entitlements.plist</span><br></pre></td></tr></table></figure>
<p>t_entitlements.plist内容如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span><br><span class="line">&lt;plist version="1.0"&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">	&lt;key&gt;application-identifier&lt;/key&gt;</span><br><span class="line">	&lt;string&gt;C789GLWV85.com.baidu.abc&lt;/string&gt;</span><br><span class="line">	&lt;key&gt;aps-environment&lt;/key&gt;</span><br><span class="line">	&lt;string&gt;production&lt;/string&gt;</span><br><span class="line">	&lt;key&gt;com.apple.developer.associated-domains&lt;/key&gt;</span><br><span class="line">	&lt;string&gt;*&lt;/string&gt;</span><br><span class="line">	&lt;key&gt;com.apple.developer.team-identifier&lt;/key&gt;</span><br><span class="line">	&lt;string&gt;C789GLWV85&lt;/string&gt;</span><br><span class="line">	&lt;key&gt;com.apple.security.application-groups&lt;/key&gt;</span><br><span class="line">	&lt;array&gt;</span><br><span class="line">		&lt;string&gt;group.com.baidu.abc&lt;/string&gt;</span><br><span class="line">	&lt;/array&gt;</span><br><span class="line">	&lt;key&gt;get-task-allow&lt;/key&gt;</span><br><span class="line">	&lt;false/&gt;</span><br><span class="line">	&lt;key&gt;keychain-access-groups&lt;/key&gt;</span><br><span class="line">	&lt;array&gt;</span><br><span class="line">		&lt;string&gt;C789GLWV85.*&lt;/string&gt;</span><br><span class="line">	&lt;/array&gt;</span><br><span class="line">&lt;/dict&gt;</span><br><span class="line">&lt;/plist&gt;</span><br></pre></td></tr></table></figure></p>
<p>得到t_entitlements.plist后，把它作为参数传递给codesign，重新签名app文件：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codesign -f -s <span class="string">"iPhone Distribution: abc"</span> /Users/pandora/Desktop/shell/oschina/Payload/iosapp<span class="variable">.app</span>/ --entitlements t_entitlements<span class="variable">.plist</span></span><br></pre></td></tr></table></figure>
<p>最后，压缩Payload文件夹，转化为ipa格式的文件，终于安装成功！本次重签名未更改bundleID，安装的时候会覆盖之前从Appstore下载的应用。如果希望两个App共存的话，需要先替换App包中Info.plist的Bundle identifier的值：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/libexec/PlistBuddy -c <span class="string">"Set :CFBundleIdentifier com.baidu.abc"</span> ./Payload/iosapp<span class="variable">.app</span>/Info<span class="variable">.plist</span></span><br></pre></td></tr></table></figure></p>
<p>然后再重新执行：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codesign -f -s <span class="string">"iPhone Distribution: abc"</span> /Users/pandora/Desktop/shell/oschina/Payload/iosapp<span class="variable">.app</span>/ --entitlements t_entitlements<span class="variable">.plist</span></span><br></pre></td></tr></table></figure></p>
<p>就得到了更改bundle id后的App包，将其压缩转换为ipa文件，使用同步堆安装至手机，就可以实现两个相同的App共存了。</p>
<h4 id="参考：">参考：</h4><p><a href="https://objccn.io/issue-17-2/" target="_blank" rel="external">ObjC中国</a></p>
<p><a href="http://www.jianshu.com/p/6b659c669338" target="_blank" rel="external">iOS重签名探索</a></p>
<p><a href="http://www.enterpriseios.com/forum/topic/Resigning_3rd_party_apps" target="_blank" rel="external">Resigning 3rd party apps</a></p>
<p><a href="http://www.pchou.info/ios/2015/12/14/ios-certification-and-code-sign.html" target="_blank" rel="external">漫谈iOS程序的证书和签名机制</a></p>
<p><a href="http://gold.xitu.io/entry/56ee241c731956005d22ac8e" target="_blank" rel="external">iOS 冰与火之歌番外篇 - App Hook 答疑以及 iOS 9 砸壳</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://dama2716588.github.io/2016/09/07/逆向Appstore应用（二）/" data-id="cissvskg60001lhb1fjg8xgbp" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>

<!-- disqus

-->

 
  
    <article id="post-逆向Appstore应用（一）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/20/逆向Appstore应用（一）/" class="article-date">
  <time datetime="2016-07-20T11:39:00.000Z" itemprop="datePublished">2016-07-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/App-Store/">App Store</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/20/逆向Appstore应用（一）/">逆向Appstore应用（一）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="写在前面">写在前面</h3><p>最近在做一些iOS启动速度优化和App瘦身相关的工作，有时候需要横向对比一下竞品的数据，免不了要对一些商店的App在许可范围内做一些手脚，下面以<a href="http://git.oschina.net/oschina/iphone-app" target="_blank" rel="external">开源中国</a>的iPhone客户端为例给大家简单介绍下操作步骤。</p>
<p>当前环境：</p>
<ul>
<li>一台越狱iPhone，系统为iOS8.3</li>
<li>mac OS X EI 10.11.5</li>
<li>iTunes 12.4</li>
</ul>
<h3 id="通过iTunes获取ipa">通过iTunes获取ipa</h3><p><img src="http://7xkptx.com1.z0.glb.clouddn.com/t34hy45u76.png" alt=""></p>
<p>点击下载，然后到我的Apps中找到刚刚下载的开源中国.ipa文件，将后缀.ipa修改为.zip，直接解压即可。找到Payload文件夹下的iosapp包文件，查看包内容，就是开发者上传Appstore的全部内容了。里面包含有png、xib等资源文件，以及本地化语言包，签名包以及二进制文件。</p>
<h3 id="使用工具解密二进制文件">使用工具解密二进制文件</h3><p><img src="http://7xkptx.com1.z0.glb.clouddn.com/old-dbd-magenta.jpg" alt="配图来自ifanr"></p>
<p>App Store上的应用都使用了DRM(Digital Rights Management)数字版权加密保护技术，想更多了解DMG历史请戳<a href="http://www.ifanr.com/473806" target="_blank" rel="external">这里</a>。首先得破解加密的可执行文件，可以通过编译<a href="https://github.com/stefanesser/dumpdecrypted" target="_blank" rel="external">dumpdecrypted</a>来解密，原理是让app预先加载一个解密的dumpdecrypted.dylib，然后在程序运行后，将代码动态解密，最后在内存中dump出来整个程序。（如果没有越狱设备，可以通过第三方市场下载未加密的ipa文件，跳过此步骤）。</p>
<p><img src="http://7xkptx.com1.z0.glb.clouddn.com/05ce2ce5f74e040661b53791b.png" alt=""></p>
<p>找到刚才解压好的开源中国二进制，名为iosapp，运行：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">otool -l iosapp_本地路径 | grep crypt</span><br><span class="line"><span class="preprocessor"># 结果为：</span></span><br><span class="line">     cryptoff <span class="number">16384</span></span><br><span class="line">    cryptsize <span class="number">5619712</span></span><br><span class="line">      cryptid <span class="number">1</span></span><br><span class="line">     cryptoff <span class="number">16384</span></span><br><span class="line">    cryptsize <span class="number">6144000</span></span><br><span class="line">      cryptid <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>cryptid 1代表加密，cryptid 0代表未加密。两个分别对应着armv7和arm64，也就是它们都有加密。接下来要开始编译dumpdecrypted.dylib文件了，首先clone <a href="https://github.com/stefanesser/dumpdecrypted.git" target="_blank" rel="external">dumpdecrypted</a>到桌面，cd到dump decrypted目录，执行以下命令，即可生成dumpdecrypted.dylib文件了。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> make</span><br><span class="line">`xcrun --sdk iphoneos --find gcc` -Os  -Wimplicit -isysroot `xcrun --sdk iphoneos --show-sdk-path` -F`xcrun --sdk iphoneos --show-sdk-path`/System/Library/Frameworks -F`xcrun --sdk iphoneos --show-sdk-path`/System/Library/PrivateFrameworks -arch armv7 -arch armv7s -arch arm64 -c -o dumpdecrypted<span class="variable">.o</span> dumpdecrypted<span class="variable">.c</span></span><br></pre></td></tr></table></figure>
<p>编译后的目录如下：</p>
<p><img src="http://7xkptx.com1.z0.glb.clouddn.com/e3fef6ddadbd919bbee9602a5.png" alt=""></p>
<p>如何使用dumpdecrypted.dylib文件来破解spa包中的二进制文件呢？</p>
<p>首先需要在已经越狱的iPhone中下载几个插件：</p>
<ul>
<li>OpenSSH，用来建立与iPhone的ssh链接，传递文件用；</li>
<li>adv-cmds，在iPhone上使用<em>ps命令</em>查看进程，方便找到当前运行的App在iPhone中的文件目录；</li>
<li>iFile，在iPhone上建立一个web server，方便与mac传递数据；</li>
</ul>
<p>通过Cydia安装好插件后，就要开始解密iosapp这个文件了。在iPhone设置中查找当前链接网络的ip地址，比如是：192.168.0.100，打开mac命令行，建立ssh链接：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@192.168.0.100</span><br></pre></td></tr></table></figure>
<p>此时提示输入密码，默认为：alpine，无需修改。连接成功后，cd 到 /var/mobile/Containers/Bundle/Application/ 目录下，可能看到所有安装的App文件夹，在iPhone中打开开源中国App，保持前台运行。然后在mac终端执行以下命令：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -e | grep var</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">143</span> ??         <span class="number">0</span>:<span class="number">04.00</span> /usr/libexec/pkd -d/var/db/PlugInKit-Annotations</span><br><span class="line"> <span class="number">398</span> ??         <span class="number">0</span>:<span class="number">01.08</span> /private/var/db/stash/_<span class="variable">.T1qNfY</span>/Applications/MobileSafari<span class="variable">.app</span>/webbookmarksd</span><br><span class="line"> <span class="number">529</span> ??         <span class="number">0</span>:<span class="number">04.78</span> /private/var/db/stash/_<span class="variable">.T1qNfY</span>/Applications/Stocks<span class="variable">.app</span>/PlugIns/StocksWidget<span class="variable">.appex</span>/StocksWidget</span><br><span class="line"> <span class="number">530</span> ??         <span class="number">0</span>:<span class="number">01.77</span> /private/var/db/stash/_<span class="variable">.T1qNfY</span>/Applications/MobileCal<span class="variable">.app</span>/PlugIns/CalendarWidget<span class="variable">.appex</span>/CalendarWidget</span><br><span class="line"><span class="number">3490</span> ??         <span class="number">0</span>:<span class="number">14.24</span> /var/mobile/Containers/Bundle/Application/<span class="number">7738</span>D5DE-B38D-<span class="number">4</span>BF1-<span class="number">9551</span>-BF671978045F/CocoaPods<span class="variable">.app</span>/CocoaPods</span><br><span class="line"><span class="number">3622</span> ??         <span class="number">0</span>:<span class="number">08.91</span> /var/mobile/Containers/Bundle/Application/B590E6C8-D5FA-<span class="number">4697</span>-AF4B-EF717ADBCB90/BaiduBoxApp<span class="variable">.app</span>/BaiduBoxApp</span><br><span class="line"><span class="number">4328</span> ??         <span class="number">0</span>:<span class="number">06.65</span> /var/mobile/Containers/Bundle/Application/<span class="number">86E38</span>E63-<span class="number">5</span>FF3-<span class="number">4</span>EF5-AB07-D13C4CB70168/iosapp<span class="variable">.app</span>/iosapp</span><br><span class="line"><span class="number">4350</span> ??         <span class="number">0</span>:<span class="number">01.47</span> /var/mobile/Containers/Bundle/Application/FBA32574-<span class="number">0453</span>-<span class="number">4</span>BB6-<span class="number">9</span>F46-A87757F22325/WeChat<span class="variable">.app</span>/WeChat</span><br><span class="line"><span class="number">4394</span> ttys000    <span class="number">0</span>:<span class="number">00.01</span> grep var</span><br></pre></td></tr></table></figure>
<p>由此可见开源中国的App运行在/var/mobile/Containers/Bundle/Application/86E38E63-5FF3-4EF5-AB07-D13C4CB70168/iosapp.app/目录下，每个app目录下都有一个Info.plist。我们可以通过这个Info.plist得到app的Bundle ID：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /var/mobile/Containers/Bundle/Application/<span class="number">86E38</span>E63-<span class="number">5</span>FF3-<span class="number">4</span>EF5-AB07-D13C4CB70168/iosapp<span class="variable">.app</span>/Info<span class="variable">.plist</span></span><br></pre></td></tr></table></figure></p>
<p>得到开源中的的Bundle ID为net.oschina.iosapp，由于App的运行会受到沙盒的限制，因此dump出来的app只能保存在data目录下，这里我们可以通过Bundle ID和一个private API得到data目录的位置：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Class cls = <span class="built_in">NSClassFromString</span>(<span class="string">@"LSApplicationWorkspace"</span>);</span><br><span class="line"><span class="keyword">id</span> s = [(<span class="keyword">id</span>)cls performSelector:<span class="built_in">NSSelectorFromString</span>(<span class="string">@"defaultWorkspace"</span>)];</span><br><span class="line"><span class="built_in">NSArray</span> *arr = [s performSelector:<span class="built_in">NSSelectorFromString</span>(<span class="string">@"allInstalledApplications"</span>)];</span><br><span class="line">Class Proxy  = <span class="built_in">NSClassFromString</span>(<span class="string">@"LSApplicationProxy"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">id</span> proxy <span class="keyword">in</span> arr) &#123;</span><br><span class="line">    <span class="keyword">id</span> bundleID = [proxy valueForKey:<span class="string">@"applicationIdentifier"</span>];</span><br><span class="line">    <span class="keyword">if</span> (bundleID &amp;&amp; [bundleID isEqualToString:<span class="string">@"net.oschina.iosapp"</span>]) &#123;</span><br><span class="line">        <span class="keyword">id</span> dataUrl = [proxy valueForKey:<span class="string">@"dataContainerURL"</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"dataUrl : %@"</span>,dataUrl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>打印出来的data url为<code>file:///private/var/mobile/Containers/Data/Application/6C425F0E-217C-4051-A131-735F3A816D89</code>，接下来在mac终端，cd到dumpdecrypted.dylib所在目录，将dumpdecrypted.dylib拷贝到开源中国的Documents目录下:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp dumpdecrypted.dylib root@172.24.64.228:/private/var/mobile/Containers/Data/Application/6C425F0E-217C-4051-A131-735F3A816D89/Documents/dumpdecrypted.dylib</span><br></pre></td></tr></table></figure>
<p>传输成功显示：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dumpdecrypted.dylib   <span class="number">100</span>%  <span class="number">193</span>KB <span class="number">192.9</span>KB/s   <span class="number">00</span>:<span class="number">00</span></span><br></pre></td></tr></table></figure>
<p>然后进入iPhone中开源中国所在根目录的Documents下，执行<code>DYLD_INSERT_LIBRARIES=dumpdecrypted.dylib</code>相关的命令，即将开始编译：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DYLD_I<span class="built_in">NSERT_LIBRARIES</span>=dumpdecrypted<span class="variable">.dylib</span> /var/mobile/Containers/Bundle/Application/<span class="number">7202242</span>C-DABA-<span class="number">4520</span>-<span class="number">8</span>D3D-<span class="number">81448728</span>F587/iosapp<span class="variable">.app</span>/iosapp</span><br></pre></td></tr></table></figure>
<p>成功后，会在Documents目录生成名为iosapp.decrypted的文件，至此就算是破解成功了，如下图所示：<br><img src="http://7xkptx.com1.z0.glb.clouddn.com/f3fh389h4f.png" alt=""></p>
<p>如果显示<code>dumpdecrypted.dylib: stat() failed with errno=1</code> 即“Operation not permitted”，表示操作权限不够，可以将dumpdecrypted.dylib文件sip至手机的usr/lib目录下，然后再执行<code>DYLD_INSERT_LIBRARIES=dumpdecrypted.dylib</code>命令编译，此时会在usr/lib目录下生成iosapp.decrypted文件。</p>
<p><img src="http://7xkptx.com1.z0.glb.clouddn.com/9518200bbe399f475dea89e86.png" alt=""><br>砸壳后的app只能解密砸壳运行时的架构，可以看到在arm64架构下显示cryptid为0，已经成功解密。</p>
<h3 id="解密后的文件如何使用？">解密后的文件如何使用？</h3><p>在得到iosapp.decrypted后，真正的逆向App工作才刚刚开始。未完待续…</p>
<h4 id="参考：">参考：</h4><p><a href="http://www.ifanr.com/473806" target="_blank" rel="external">http://www.ifanr.com/473806</a></p>
<p><a href="http://www.liuchendi.com/2015/12/23/iOS/24_dumpdecrypted/" target="_blank" rel="external">http://www.liuchendi.com/2015/12/23/iOS/24_dumpdecrypted/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://dama2716588.github.io/2016/07/20/逆向Appstore应用（一）/" data-id="cissvskg80002lhb1v0acegzz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ipa/">ipa</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- disqus

-->

 
  
    <article id="post-一款Watch OS版微博" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/06/一款Watch OS版微博/" class="article-date">
  <time datetime="2016-04-06T06:49:47.000Z" itemprop="datePublished">2016-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/06/一款Watch OS版微博/">一款Watch OS版微博</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="写在前面">写在前面</h3><p>手表买了将近快一年的时间了，每天常用的就是运动提醒了，尤其是间隔一小时站立及步数统计，对久坐人士有很好的督促作用。一直想着做一款手表App，最近终于有些时间就开始捣鼓了，大概前后花了两个周的空闲时间，基于Watch OS 1简单实现了一款手表版的微博,如有纰漏，还望指正。</p>
<h3 id="App_Groups">App Groups</h3><p>首先了解下App Groups的概念，这是Apple在iOS8中引入的技术。旨在位于同一group的app之间共享一份数据读写空间，打破了沙盒技术对应用间通信与交互的限制。比如通知中心的Today Extension作为app功能的补充而存在，Watch App也类似于此。在开始之前需要先创建App Group。可以在Xcode的Capabilities中添加，或者在Apple developer 中心来添加，本文采用后一种方式给大家介绍。</p>
<p><img src="http://7xkptx.com1.z0.glb.clouddn.com/34f4wv4wrb.png" alt=""></p>
<p>新生成的group id为”group.baidu.com.miniweibo”，用来关联Watch App与iPhone App，实现数据共享及进程通信。创建名为MiniWeibo的Project，对应生成MiniWeibo、MiniWeibo WatchKit 1 Extension和MiniWeibo WatchKit 1 App 三个target，然后在 Xcode 的 Capabilities 选项卡下分别打开主 target 与 WatchKit Extension target下的App Groups选项，刷新选中刚创建的group id即可。如下图所示：</p>
<p><img src="http://7xkptx.com1.z0.glb.clouddn.com/43fwrgberh5.png" alt=""></p>
<p>选中后会自动添加名为MiniWeibo.entitlements与MiniWeibo WatchKit 1 Extension.entitlements的两个XML文件至工程文件中，当构建整个应用时，这两个entitlements文件也会提交给 <code>codesign</code> 作为应用所需要拥有哪些授权的参考，可以在 Xcode build setting 中的 code signing entitlements 中设置。entitlements文件内部格式如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="doctype">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">plist</span> <span class="attribute">version</span>=<span class="value">"1.0"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">dict</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">key</span>&gt;</span>com.apple.security.application-groups<span class="tag">&lt;/<span class="title">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">array</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="title">string</span>&gt;</span>group.com.baidu.miniweibo<span class="tag">&lt;/<span class="title">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">array</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">dict</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">plist</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>&lt;key&gt;com.apple.security.application-groups&lt;/key&gt;</code>标识着此应用被添加至名为group.com.baidu.miniweibo的group中，为了与扩展 (extensions) 共享数据。另外还可以添加get-task-allow用来限定只能在用于开发的证书签名下运行，以及设置asp-environment的推送环境为development或者distribution。授权信息会被包含在应用的签名信息中，可以执行<code>$ codesign -d --entitlements - Example.app</code>，返回一个XML文件，查看签名信息中具体包含了什么授权信息，方便工程配置的查看与调试。</p>
<h3 id="数据共享与调试">数据共享与调试</h3><p>App Groups共享数据可以创建group id为标记的NSUserDefaults，来写入和读取可plist化的数据对象：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)saveTextBy<span class="built_in">NSUserDefaults</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSUserDefaults</span> *shared = [[<span class="built_in">NSUserDefaults</span> alloc] initWithSuiteName:<span class="string">@"group.wangzz"</span>];</span><br><span class="line">    [shared setObject:_textField<span class="variable">.text</span> forKey:<span class="string">@"wangzz"</span>];</span><br><span class="line">    [shared synchronize];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者通过NSFileManager的containerURLForSecurityApplicationGroupIdentifier方法，创建NSFileManager的单例，来管理App Group数据。File可以是普通的二进制文件，或者是sqlite文件。MiniWeibo采用的是基于sqlite的数据存储方式，来实现App间的通信：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *dataBasePath = [[[[<span class="built_in">NSFileManager</span> defaultManager] containerURLForSecurityApplicationGroupIdentifier:<span class="string">@"group.com.baidu.miniweibo"</span>] URLByAppendingPathComponent:<span class="string">@"miniweibo.db"</span>] path];</span><br><span class="line">_queue = [FMDatabaseQueue databaseQueueWithPath:dataBasePath];</span><br></pre></td></tr></table></figure>
<p>sqlite内部的数据处理是采用第三方开源库<a href="https://github.com/ccgus/fmdb" target="_blank" rel="external">FMDB</a>来实现，详细了解请参考：<a href="https://github.com/ccgus/fmdb" target="_blank" rel="external">https://github.com/ccgus/fmdb</a></p>
<p>大致实现流程可以描述为：每个可交互的 <code>WKInterfaceObject</code> 子类都对应了一个 action，来调用Watch Kit中openParentApplication方法，唤起iOS target中<code>application:handleWatchKitExtensionRequestreply:</code>代理方法，请求网络数据，需要持久化的通过sqlite存储共享，临时数据通过reply回调，传递给Watch Extension来刷新Watch App界面。</p>
<p>开发的过程中，需要在iPhone App 与 Watch App之间频繁进程切换，通过Xcode -&gt; Debug -&gt; Attach to Process -&gt; [process name]，绑定iOS App 与 Watch Extension进行调试。</p>
<h3 id="工程架构">工程架构</h3><p><img src="http://7xkptx.com1.z0.glb.clouddn.com/2fwehetjty.png" alt=""></p>
<p>Watch App是基于iOS App而存在的，WatchKit Extension主要负责逻辑部分，将随iOS App的主target被一同安装到iPhone中，通过UIApplicationDelegate及WKInterfaceController来调度手表上负责界面显示的WatchKit App。</p>
<p><img src="http://7xkptx.com1.z0.glb.clouddn.com/3fwregw5.png?imageView2/2/h/360" alt="图片来自 http://tech.glowing.com/cn/make_apple_watch_app/"></p>
<h4 id="1，主要类">1，主要类</h4><p>如同WKInterfaceController一样，WKInterfaceButton、WKInterfaceLabel、WKInterfaceImage等并非是UIView的子类，而是继承自NSObject，Watch App 中实际展现和渲染在屏幕上的 view 对于代码来说是非直接可见的，我们只能在 Extension target 中通过对应的代理对象对属性进行设置，由 WatchKit 传递给手表中的 Watch App 并进行界面刷新。</p>
<h4 id="2，Glance_和_Notification">2，Glance 和 Notification</h4><p>GlanceController意为速览，算是Watch App的快捷显示及操作界面，如音乐App的播放控制，天气App的数据展示等。有些Glance界面是固定的，无需每次显示的时候刷新，只需在initWithContext中初始化即可；有些是需要动态展示，每次滑出Glance的时候都需要刷新界面，则需要调用呈现时的 <code>-willActivate</code> 方法，类似UIViewController中的viewWillAppear，相对的，<code>-didDeactivate</code>方法可以理解为viewDidDisappear，即界面即将消失。</p>
<p>当我们加入了一个新的通知界面之后，Xcode就会为我们生成这两个interface，分为Static Notification Interface Controller 和 Dynamic Notification Interface Controller两种。动态的Interface是可选的。当一个的通知到来之后，系统会优先去呈现动态的通知界面，当动态界面不可用或者低电量时才会去呈现静态的。动态通知使得我们可以提供一个更加丰富的体验给用户，如同其他Interface Controller一样，可以通过Outlet及IBAction来关联和定义，增强可操作性。通知流程如下图：</p>
<p><img src="http://7xkptx.com1.z0.glb.clouddn.com/3df3wg45g.png" alt=""></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)didReceiveRemoteNotification:(<span class="built_in">NSDictionary</span> *)remoteNotification withCompletion:(<span class="keyword">void</span> (^)(WKUserNotificationInterfaceType))completionHandler &#123;</span><br><span class="line">    <span class="comment">// This method is called when a remote notification needs to be presented.</span></span><br><span class="line">    <span class="comment">// Implement it if you use a dynamic notification interface.</span></span><br><span class="line">    <span class="comment">// Populate your dynamic notification interface as quickly as possible.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// After populating your dynamic notification interface call the completion block.</span></span><br><span class="line">    completionHandler(WKUserNotificationInterfaceTypeCustom);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    completionHandler(WKUserNotificationInterfaceTypeCustom)中参数WKUserNotificationInterfaceTypeCustom决定了优先呈现Dynamic界面，如果是WKUserNotificationInterfaceTypeDefault则会显示Static通知界面。在调用completionHandler之前系统会短暂地显示Short-Look Interface，它不能滚动和定制，系统会显示App 的名字以及App 的图标Icon，以及一条自定义通知信息，同时在准备数据，构建Long-Look界面，然后系统会迅速的切换到The Long-Look Interface中，包含三个区域：顶部Sash、中间Content area及底部按钮区域，点击Sash、Content area都会直接进入Watch App，点击底部按钮区域可以触发Watch Kit与Watch Extension及iOS App交互。</p>
<p>准备自定义的NotificationInterface后，就可以开始测试了，模拟器可以直接选择Notification target编译即可。真机测试，可以使用Mac 端 apns小工具<a href="https://github.com/shaojiankui/SmartPush" target="_blank" rel="external">SmartPush</a>，进行开发和生产环境的调试。至此MiniWeibo工程的开发暂告一段落，附张截图吧：</p>
<p><img src="http://7xkptx.com1.z0.glb.clouddn.com/1a0cef138909a32f8519deb24.png" alt=""></p>
<h3 id="开发中的几个Tips：">开发中的几个Tips：</h3><ul>
<li><p>图片缓存</p>
<p>使用<code>addCachedImageWithData:name:</code>来添加NSData缓存图片数据，相比较<code>addCachedImage:name:</code>方法避免了使用PND编码的过程，节省存储空间。每个Watch App大概有5mb的缓存分配，如果存储控件不足时，需要调用 <code>removeCachedImageWithName:</code>或者 <code>removeAllCachedImages</code>方法来清除数据。否则WatchKit将从最老的数据开始自动删除，为新数据腾出空间。</p>
</li>
</ul>
<ul>
<li><p>WKInterfaceLabel高度自适应与滚动</p>
<p>不同与UIKit，很多视图控件无法通过手写的方式来管理，需要在Interface.storyboard中设置参数。比如WKInterfaceLabel需要多行显示和滚动时，需要设置Label-&gt;Lines为0，Size-&gt;Width为Relative to Container，以及Size-&gt;Height为Size To Fit Content，意为宽度与父视图一样，高度为内容自适应，即可实现多行显示与滚动了。</p>
</li>
<li><p>WKInterfaceGroup的使用</p>
<p>WKInterfaceGroup继承自NSObject，可以理解为视图块，集中管理某个区域的视图显示，比如table cell。可以指定background colour、alpha及Radius等UIView的属性设置，在InterfaceController中使用频率很高。</p>
</li>
</ul>
<h3 id="关于Watch_OS_2">关于Watch OS 2</h3><p>Watch OS 2引入了ClockKit与WatchConnectivity框架，不仅增强了表盘自定义控件的灵活性，数据共享操作改进很大，其中extension 是直接存在于手表中的，在Watch OS 1中通过app group管理的方式已经失效。另外HealthKit也得到增强，健康监护及运动统计类的App会大有施展空间。</p>
<h4 id="参考">参考</h4><p>1，<a href="https://onevcat.com/2014/08/notification-today-widget/" target="_blank" rel="external">https://onevcat.com/2014/08/notification-today-widget/</a> （<a href="https://onevcat.com/#blog" target="_blank" rel="external">OneV’s Den</a>）</p>
<p>2，<a href="http://foggry.com/blog/2014/06/23/wwdc2014zhi-app-extensionsxue-xi-bi-ji/" target="_blank" rel="external">http://foggry.com/blog/2014/06/23/wwdc2014zhi-app-extensionsxue-xi-bi-ji/</a> （<a href="http://foggry.com/" target="_blank" rel="external">王中周的技术博客</a>）</p>
<p>3，<a href="http://objccn.io/issue-17-2/" target="_blank" rel="external">http://objccn.io/issue-17-2/</a> （<a href="http://objccn.io/" target="_blank" rel="external">objc中国</a>）</p>
<p>4，<a href="https://developer.apple.com/library/ios/documentation/General/Conceptual/WatchKitProgrammingGuide/BasicSupport.html" target="_blank" rel="external">Apple Watch 文档</a></p>
<h4 id=""> </h4>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://dama2716588.github.io/2016/04/06/一款Watch OS版微博/" data-id="cissvskgo000slhb1prurldnb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Watch-OS/">Watch OS</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- disqus

-->

 
  
    <article id="post-关于GCD的几个用例" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/11/关于GCD的几个用例/" class="article-date">
  <time datetime="2016-03-11T15:13:00.000Z" itemprop="datePublished">2016-03-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/11/关于GCD的几个用例/">关于GCD的几个用例</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>GCD作为日常开发中的使用已经非常普遍，基于C的API为应用在多核硬件上高效运行提供了有力支持。本文分场景写了几个测试Demo，方便大家理解与应用。</p>
<h4 id="1，dispatch_get_global_queue与dispatch_get_main_queue交互">1，dispatch_get_global_queue与dispatch_get_main_queue交互</h4><p>很多应用场景需要后台读写大量数据，通过dispatch_get_global_queue函数可以获取全局队列来并发执行后台任务，并再结束后更新UI，保证应用的流程，避免主线程阻塞。代码如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)test1</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line">    dispatch_group_t group = dispatch_group_create();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"___%i %@"</span>, i, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_group_notify(group, queue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"currentThread1 %@"</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"执行完毕"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"currentThread2 %@"</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"main_queue 执行完毕"</span>);</span><br><span class="line">        &#125;);        </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">test1：</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">37.293</span> GCDSample[<span class="number">3892</span>:<span class="number">2238505</span>] ___0 &lt;<span class="built_in">NSThread</span>: <span class="number">0x12e53e570</span>&gt;&#123;number = <span class="number">2</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">37.293</span> GCDSample[<span class="number">3892</span>:<span class="number">2238506</span>] ___2 &lt;<span class="built_in">NSThread</span>: <span class="number">0x12e67f1e0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">37.293</span> GCDSample[<span class="number">3892</span>:<span class="number">2238504</span>] ___3 &lt;<span class="built_in">NSThread</span>: <span class="number">0x12e689760</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">37.293</span> GCDSample[<span class="number">3892</span>:<span class="number">2238507</span>] ___1 &lt;<span class="built_in">NSThread</span>: <span class="number">0x12e683590</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">37.294</span> GCDSample[<span class="number">3892</span>:<span class="number">2238505</span>] ___4 &lt;<span class="built_in">NSThread</span>: <span class="number">0x12e53e570</span>&gt;&#123;number = <span class="number">2</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">37.295</span> GCDSample[<span class="number">3892</span>:<span class="number">2238506</span>] ___5 &lt;<span class="built_in">NSThread</span>: <span class="number">0x12e67f1e0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">37.295</span> GCDSample[<span class="number">3892</span>:<span class="number">2238504</span>] ___6 &lt;<span class="built_in">NSThread</span>: <span class="number">0x12e689760</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">37.295</span> GCDSample[<span class="number">3892</span>:<span class="number">2238507</span>] ___7 &lt;<span class="built_in">NSThread</span>: <span class="number">0x12e683590</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">37.295</span> GCDSample[<span class="number">3892</span>:<span class="number">2238505</span>] ___8 &lt;<span class="built_in">NSThread</span>: <span class="number">0x12e53e570</span>&gt;&#123;number = <span class="number">2</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">37.298</span> GCDSample[<span class="number">3892</span>:<span class="number">2238506</span>] ___9 &lt;<span class="built_in">NSThread</span>: <span class="number">0x12e67f1e0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">37.299</span> GCDSample[<span class="number">3892</span>:<span class="number">2238506</span>] currentThread1 &lt;<span class="built_in">NSThread</span>: <span class="number">0x12e67f1e0</span>&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">37.299</span> GCDSample[<span class="number">3892</span>:<span class="number">2238506</span>] 执行完毕</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">37.302</span> GCDSample[<span class="number">3892</span>:<span class="number">2238481</span>] currentThread2 &lt;<span class="built_in">NSThread</span>: <span class="number">0x12e50c390</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">37.303</span> GCDSample[<span class="number">3892</span>:<span class="number">2238481</span>] main_queue 执行完毕</span><br></pre></td></tr></table></figure>
<h4 id="2，异步线程中串行执行任务">2，异步线程中串行执行任务</h4><p>test1中dispatch_group_async以并发的方式开启异步线程，不能保证执行顺序，如果想在并发线程中串行执行任务该如何做呢？只需要创建一个串行队列，加入group任务即可。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)test1</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"code begin"</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"currentThread0 %@"</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    dispatch_group_t group = dispatch_group_create();</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> serialQueue = dispatch_queue_create(<span class="literal">NULL</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        dispatch_group_async(group, serialQueue, ^&#123;</span><br><span class="line">            [<span class="built_in">NSThread</span> sleepForTimeInterval:.<span class="number">1</span>f];</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"___%i %@"</span>, i, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    dispatch_group_notify(group, serialQueue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"currentThread1 %@"</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"执行完毕"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"code end"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">test2:</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">10.366</span> GCDSample[<span class="number">3879</span>:<span class="number">2235420</span>] code begin</span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">10.367</span> GCDSample[<span class="number">3879</span>:<span class="number">2235420</span>] currentThread0 &lt;<span class="built_in">NSThread</span>: <span class="number">0x14c50c350</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">10.367</span> GCDSample[<span class="number">3879</span>:<span class="number">2235420</span>] code end</span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">10.472</span> GCDSample[<span class="number">3879</span>:<span class="number">2235438</span>] ___0 &lt;<span class="built_in">NSThread</span>: <span class="number">0x14c692ed0</span>&gt;&#123;number = <span class="number">2</span>, name = (null)&#125;</span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">10.577</span> GCDSample[<span class="number">3879</span>:<span class="number">2235438</span>] ___1 &lt;<span class="built_in">NSThread</span>: <span class="number">0x14c692ed0</span>&gt;&#123;number = <span class="number">2</span>, name = (null)&#125;</span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">10.683</span> GCDSample[<span class="number">3879</span>:<span class="number">2235438</span>] ___2 &lt;<span class="built_in">NSThread</span>: <span class="number">0x14c692ed0</span>&gt;&#123;number = <span class="number">2</span>, name = (null)&#125;</span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">10.784</span> GCDSample[<span class="number">3879</span>:<span class="number">2235438</span>] ___3 &lt;<span class="built_in">NSThread</span>: <span class="number">0x14c692ed0</span>&gt;&#123;number = <span class="number">2</span>, name = (null)&#125;</span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">10.890</span> GCDSample[<span class="number">3879</span>:<span class="number">2235438</span>] ___4 &lt;<span class="built_in">NSThread</span>: <span class="number">0x14c692ed0</span>&gt;&#123;number = <span class="number">2</span>, name = (null)&#125;</span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">10.995</span> GCDSample[<span class="number">3879</span>:<span class="number">2235438</span>] ___5 &lt;<span class="built_in">NSThread</span>: <span class="number">0x14c692ed0</span>&gt;&#123;number = <span class="number">2</span>, name = (null)&#125;</span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">11.101</span> GCDSample[<span class="number">3879</span>:<span class="number">2235438</span>] ___6 &lt;<span class="built_in">NSThread</span>: <span class="number">0x14c692ed0</span>&gt;&#123;number = <span class="number">2</span>, name = (null)&#125;</span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">11.206</span> GCDSample[<span class="number">3879</span>:<span class="number">2235438</span>] ___7 &lt;<span class="built_in">NSThread</span>: <span class="number">0x14c692ed0</span>&gt;&#123;number = <span class="number">2</span>, name = (null)&#125;</span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">11.309</span> GCDSample[<span class="number">3879</span>:<span class="number">2235438</span>] ___8 &lt;<span class="built_in">NSThread</span>: <span class="number">0x14c692ed0</span>&gt;&#123;number = <span class="number">2</span>, name = (null)&#125;</span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">11.411</span> GCDSample[<span class="number">3879</span>:<span class="number">2235438</span>] ___9 &lt;<span class="built_in">NSThread</span>: <span class="number">0x14c692ed0</span>&gt;&#123;number = <span class="number">2</span>, name = (null)&#125;</span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">11.411</span> GCDSample[<span class="number">3879</span>:<span class="number">2235438</span>] currentThread1 &lt;<span class="built_in">NSThread</span>: <span class="number">0x14c692ed0</span>&gt;&#123;number = <span class="number">2</span>, name = (null)&#125;</span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">07</span>:<span class="number">11.411</span> GCDSample[<span class="number">3879</span>:<span class="number">2235438</span>] 执行完毕</span><br></pre></td></tr></table></figure>
<h4 id="3，dispatch_barrier_async，分割多任务线程">3，dispatch_barrier_async，分割多任务线程</h4><p>如果有10个并发任务，想要分成两组，比如指定前五个任务执行完之后，优先执行第六个任务，再执行剩下的操作，可以通过dispatch_barrier_async来分割开，示例：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)test3</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> concurrentQueue = (&#123;</span><br><span class="line">        <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"concurrentQueue"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">        queue;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i != <span class="number">5</span>) &#123;</span><br><span class="line">            <span class="built_in">dispatch_async</span>(concurrentQueue, ^&#123;</span><br><span class="line">                [<span class="built_in">NSThread</span> sleepForTimeInterval:arc4random_uniform(<span class="number">3</span>)];</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"dispatch_async %i"</span>, i);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            dispatch_barrier_async(concurrentQueue, ^&#123;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"dispatch_barrier_async"</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">test3</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">47</span>:<span class="number">32.397</span> GCDSample[<span class="number">3949</span>:<span class="number">2246479</span>] <span class="built_in">dispatch_async</span> <span class="number">1</span></span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">47</span>:<span class="number">32.400</span> GCDSample[<span class="number">3949</span>:<span class="number">2246481</span>] <span class="built_in">dispatch_async</span> <span class="number">3</span></span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">47</span>:<span class="number">33.403</span> GCDSample[<span class="number">3949</span>:<span class="number">2246480</span>] <span class="built_in">dispatch_async</span> <span class="number">2</span></span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">47</span>:<span class="number">34.400</span> GCDSample[<span class="number">3949</span>:<span class="number">2246477</span>] <span class="built_in">dispatch_async</span> <span class="number">0</span></span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">47</span>:<span class="number">34.405</span> GCDSample[<span class="number">3949</span>:<span class="number">2246479</span>] <span class="built_in">dispatch_async</span> <span class="number">4</span></span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">47</span>:<span class="number">34.406</span> GCDSample[<span class="number">3949</span>:<span class="number">2246477</span>] dispatch_barrier_async</span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">47</span>:<span class="number">34.406</span> GCDSample[<span class="number">3949</span>:<span class="number">2246479</span>] <span class="built_in">dispatch_async</span> <span class="number">6</span></span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">47</span>:<span class="number">35.411</span> GCDSample[<span class="number">3949</span>:<span class="number">2246479</span>] <span class="built_in">dispatch_async</span> <span class="number">7</span></span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">47</span>:<span class="number">35.412</span> GCDSample[<span class="number">3949</span>:<span class="number">2246480</span>] <span class="built_in">dispatch_async</span> <span class="number">9</span></span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">47</span>:<span class="number">35.411</span> GCDSample[<span class="number">3949</span>:<span class="number">2246477</span>] <span class="built_in">dispatch_async</span> <span class="number">8</span></span><br></pre></td></tr></table></figure>
<h4 id="4，串行队列死锁">4，串行队列死锁</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)test4</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"1"</span>);</span><br><span class="line">    <span class="built_in">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"2"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"3"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)test4_1 &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"1"</span>);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"2 %@"</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        <span class="built_in">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"3 %@"</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"4 %@"</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"5"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法test4会造成死锁，因为main queue需要等待dispatch_sync函数中block返回才能继续执行，而通过dispatch_sync放入main queue的block按照FIFO的原则（先入先出）现在得不到执行，就造成了相互等待的局面，产生死锁。将同步的串行队列放到另外一个异步线程就能够解决（如方法test4_1所示）。所以在使用dispatch_sync的时候需要很谨慎，需要先执行<code>[NSThread isMainThread]</code>判断下当前任务是否在mian queue中调用，比如有一段代码在后台执行，而它需要从界面控制层获取一个值。那么你可以使用dispatch_sync简单办到。执行结果：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">test4</span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">17</span>:<span class="number">23</span>:<span class="number">30.020</span> GCDSample[<span class="number">3896</span>:<span class="number">2239119</span>] <span class="number">1</span></span><br><span class="line"></span><br><span class="line">test4_1</span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">17</span>:<span class="number">30</span>:<span class="number">11.900</span> GCDSample[<span class="number">1197</span>:<span class="number">730552</span>] <span class="number">1</span></span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">17</span>:<span class="number">30</span>:<span class="number">11.901</span> GCDSample[<span class="number">1197</span>:<span class="number">730552</span>] <span class="number">5</span></span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">17</span>:<span class="number">30</span>:<span class="number">11.903</span> GCDSample[<span class="number">1197</span>:<span class="number">730564</span>] <span class="number">2</span> &lt;<span class="built_in">NSThread</span>: <span class="number">0x170263080</span>&gt;&#123;number = <span class="number">2</span>, name = (null)&#125;</span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">17</span>:<span class="number">30</span>:<span class="number">11.933</span> GCDSample[<span class="number">1197</span>:<span class="number">730552</span>] <span class="number">3</span> &lt;<span class="built_in">NSThread</span>: <span class="number">0x174075400</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</span><br><span class="line"> <span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">17</span>:<span class="number">30</span>:<span class="number">11.933</span> GCDSample[<span class="number">1197</span>:<span class="number">730564</span>] <span class="number">4</span> &lt;<span class="built_in">NSThread</span>: <span class="number">0x170263080</span>&gt;&#123;number = <span class="number">2</span>, name = (null)&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="5，dispatch_semaphore_t_控制并发线程数">5，dispatch_semaphore_t 控制并发线程数</h4><p>有时在执行多任务时需要避免抢占资源以及性能过多消耗的情况，需要在特定时间内控制同时执行的任务数量，在NSOperationQueue可以通过maxConcurrentOperationCount来控制，在GCD中可以指定semaphore来控制了。先介绍3个函数，dispatch_semaphore_create创建一个semaphore；dispatch_semaphore_wait等待信号，当信号总量少于0的时候就会一直等待，否则就可以正常的执行，并让信号总量-1；dispatch_semaphore_signal是发送一个信号，自然会让信号总量加1。看一个小例子：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)test7</span><br><span class="line">&#123;</span><br><span class="line">    _semaphore = dispatch_semaphore_create(<span class="number">2</span>);				</span><br><span class="line">    [<span class="keyword">self</span> task7_1];</span><br><span class="line">    [<span class="keyword">self</span> task7_2];</span><br><span class="line">    [<span class="keyword">self</span> task7_3];</span><br><span class="line">    [<span class="keyword">self</span> task7_4];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)task7_1</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">        dispatch_semaphore_wait(_semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"7_1_begin"</span>);</span><br><span class="line">        sleep(<span class="number">4</span>);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"7_1_end"</span>);</span><br><span class="line">        dispatch_semaphore_signal(_semaphore);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)task7_2</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">        dispatch_semaphore_wait(_semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"7_2_begin"</span>);</span><br><span class="line">        sleep(<span class="number">4</span>);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"7_2_end"</span>);</span><br><span class="line">        dispatch_semaphore_signal(_semaphore);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)task7_3</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">        dispatch_semaphore_wait(_semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"7_3_begin"</span>);</span><br><span class="line">        sleep(<span class="number">4</span>);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"7_3_end"</span>);</span><br><span class="line">        dispatch_semaphore_signal(_semaphore);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)task7_4</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">        dispatch_semaphore_wait(_semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"7_4_begin"</span>);</span><br><span class="line">        sleep(<span class="number">4</span>);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"7_4_end"</span>);</span><br><span class="line">        dispatch_semaphore_signal(_semaphore);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">semaphore 为 <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">33</span>:<span class="number">11.957</span> GCDSample[<span class="number">22394</span>:<span class="number">2943718</span>] <span class="number">7</span>_1_begin</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">33</span>:<span class="number">15.959</span> GCDSample[<span class="number">22394</span>:<span class="number">2943718</span>] <span class="number">7</span>_1_end</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">33</span>:<span class="number">15.960</span> GCDSample[<span class="number">22394</span>:<span class="number">2943717</span>] <span class="number">7</span>_2_begin</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">33</span>:<span class="number">19.964</span> GCDSample[<span class="number">22394</span>:<span class="number">2943717</span>] <span class="number">7</span>_2_end</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">33</span>:<span class="number">19.965</span> GCDSample[<span class="number">22394</span>:<span class="number">2943721</span>] <span class="number">7</span>_3_begin</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">33</span>:<span class="number">23.970</span> GCDSample[<span class="number">22394</span>:<span class="number">2943721</span>] <span class="number">7</span>_3_end</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">33</span>:<span class="number">23.970</span> GCDSample[<span class="number">22394</span>:<span class="number">2943727</span>] <span class="number">7</span>_4_begin</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">33</span>:<span class="number">27.975</span> GCDSample[<span class="number">22394</span>:<span class="number">2943727</span>] <span class="number">7</span>_4_end</span><br><span class="line"></span><br><span class="line">------- ------- ------- ------- ------- ------- ------- ----</span><br><span class="line"></span><br><span class="line">semaphore 为 <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">33</span>:<span class="number">47.396</span> GCDSample[<span class="number">22406</span>:<span class="number">2944975</span>] <span class="number">7</span>_2_begin</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">33</span>:<span class="number">47.396</span> GCDSample[<span class="number">22406</span>:<span class="number">2944974</span>] <span class="number">7</span>_1_begin</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">33</span>:<span class="number">51.398</span> GCDSample[<span class="number">22406</span>:<span class="number">2944975</span>] <span class="number">7</span>_2_end</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">33</span>:<span class="number">51.398</span> GCDSample[<span class="number">22406</span>:<span class="number">2944974</span>] <span class="number">7</span>_1_end</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">33</span>:<span class="number">51.398</span> GCDSample[<span class="number">22406</span>:<span class="number">2944976</span>] <span class="number">7</span>_3_begin</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">33</span>:<span class="number">51.398</span> GCDSample[<span class="number">22406</span>:<span class="number">2944983</span>] <span class="number">7</span>_4_begin</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">33</span>:<span class="number">55.401</span> GCDSample[<span class="number">22406</span>:<span class="number">2944976</span>] <span class="number">7</span>_3_end</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">16</span>:<span class="number">33</span>:<span class="number">55.401</span> GCDSample[<span class="number">22406</span>:<span class="number">2944983</span>] <span class="number">7</span>_4_end</span><br></pre></td></tr></table></figure>
<p>可以看到，并发执行任务的数量取决于<code>_semaphore = dispatch_semaphore_create(2);</code>传入的数字，当为1时，效果如同执行串行队列。</p>
<h4 id="6，dispatch_set_target_queue_设置队列优先级">6，dispatch_set_target_queue 设置队列优先级</h4><p>如果有串行队列A和并行队列B，队列A中加入任务1，队列B中加入任务2、任务3，如果确保1、2、3顺序执行呢？可以通过dispatch_set_target_queue设置队列的优先级，将队列AB指派到队列C上，任务123将会在串行队列C中顺序执行。代码如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)test8</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> serialQueue = dispatch_queue_create(<span class="string">"com.starming.gcddemo.serialqueue"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> firstQueue = dispatch_queue_create(<span class="string">"com.starming.gcddemo.firstqueue"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> secondQueue = dispatch_queue_create(<span class="string">"com.starming.gcddemo.secondqueue"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    </span><br><span class="line">    dispatch_set_target_queue(firstQueue, serialQueue);</span><br><span class="line">    dispatch_set_target_queue(secondQueue, serialQueue);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(firstQueue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"1 %@"</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3.</span>f];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(secondQueue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"2 %@"</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2.</span>f];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(secondQueue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"3 %@"</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1.</span>f];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">17</span>:<span class="number">31</span>:<span class="number">41.515</span> GCDSample[<span class="number">1202</span>:<span class="number">730942</span>] <span class="number">1</span> &lt;<span class="built_in">NSThread</span>: <span class="number">0x170078340</span>&gt;&#123;number = <span class="number">2</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">17</span>:<span class="number">31</span>:<span class="number">44.518</span> GCDSample[<span class="number">1202</span>:<span class="number">730942</span>] <span class="number">2</span> &lt;<span class="built_in">NSThread</span>: <span class="number">0x170078340</span>&gt;&#123;number = <span class="number">2</span>, name = (null)&#125;</span><br><span class="line"><span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">17</span>:<span class="number">31</span>:<span class="number">46.520</span> GCDSample[<span class="number">1202</span>:<span class="number">730942</span>] <span class="number">3</span> &lt;<span class="built_in">NSThread</span>: <span class="number">0x170078340</span>&gt;&#123;number = <span class="number">2</span>, name = (null)&#125;</span><br></pre></td></tr></table></figure></p>
<p>未完待续，Have fun!</p>
<p>参考：<br><a href="https://github.com/nixzhu/dev-blog/blob/master/2014-04-19-grand-central-dispatch-in-depth-part-1.md" target="_blank" rel="external">https://github.com/nixzhu/dev-blog/blob/master/2014-04-19-grand-central-dispatch-in-depth-part-1.md</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://dama2716588.github.io/2016/03/11/关于GCD的几个用例/" data-id="cissvskgk000klhb1stxz5hna" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/GCD/">GCD</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- disqus

-->

 
  
    <article id="post-FMDB使用摘要" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/09/FMDB使用摘要/" class="article-date">
  <time datetime="2016-03-09T08:47:00.000Z" itemprop="datePublished">2016-03-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/09/FMDB使用摘要/">FMDB使用摘要</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近项目中需要加入持久化数据缓存的需求，在比较了<a href="https://github.com/enormego/EGOCache" target="_blank" rel="external">EGOCache</a>与<a href="https://github.com/ccgus/fmdb" target="_blank" rel="external">FMDB</a>之后，决定采用基于SQLite3的FMDB来实现，结合<a href="https://github.com/AFNetworking/AFNetworking" target="_blank" rel="external">AFNetworking</a>封装了一套API缓存方案，在此简单介绍下具体逻辑与注意事项。</p>
<h4 id="1，使用FMDatabaseQueue">1，使用FMDatabaseQueue</h4><p>FMDB的每一次数据读写操作，都可以理解为一个Operation，数据库是每个Operation对应的数据源，所以需要保证操作的线程安全，这就引入了FMDatabaseQueue的概念。每次Operation顺序加入队列中，保证了数据访问的有序进行，互补干扰。</p>
<p><code>+ (instancetype)databaseQueueWithPath:(NSString*)aPath</code></p>
<p>通过dispatch_queue_create创建并发队列，不同的dataPath通过FMDatabaseQueue来维护，多个queue之间并发执行任务，保证了数据读写的效率。</p>
<p><code>- (void)inDatabase:(void (^)(FMDatabase *db))block</code></p>
<p>每次Operation通过inDatabase执行，dispatch_sync方法来添加串行任务，保证了每个FMDatabaseQueue数据的安全与有序。在添加任务前，调用<strong>dispatch_get_specific</strong>获得<strong>FMDatabaseQueue</strong>关联的线程，检查是否是同一个线程，因为串行队列里面同步执行<strong>dispatch_sync</strong>会造成死锁。</p>
<h4 id="2，存储json数据">2，存储json数据</h4><p>在GET到API返回json数据时候，常常会遇到字典或者数组嵌套的情况，使用FMDB写入数据时，如果Key-Value一一对应会比较麻烦，所以，把整条记录转换为string对象来存储，在不降低性能的情况下对数据的写入与读取十分便捷。在此需要注意sql语句中的string要作为参数写入，以免引起syntax error，例如：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 正确：</span></span><br><span class="line"><span class="built_in">NSString</span>  *insertSQl=[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"insert or replace into '%@' (ID,JSONString) values (?,?) "</span>,tableName];</span><br><span class="line">  [_queue inTransaction:^(FMDatabase *db, <span class="built_in">BOOL</span> *rollback) &#123;</span><br><span class="line">     <span class="keyword">if</span>(![db executeUpdate:insertSQl,objId,jsonStr])&#123;</span><br><span class="line">          BDLog(<span class="string">@"rollback Table %@"</span>,tableName);</span><br><span class="line">          *rollback = <span class="literal">YES</span>;</span><br><span class="line">          <span class="keyword">return</span> ;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误：</span></span><br><span class="line"><span class="built_in">NSString</span>  *insertSQl=[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"insert or replace into '%@' (ID,JSONString) values (%@,%@) "</span>,tableName,objId,jsonStr];   </span><br><span class="line">  [_queue inTransaction:^(FMDatabase *db, <span class="built_in">BOOL</span> *rollback) &#123;</span><br><span class="line">      <span class="keyword">if</span>(![db executeUpdate:insertSQl])&#123;</span><br><span class="line">          BDLog(<span class="string">@"rollback Table %@"</span>,tableName);</span><br><span class="line">          *rollback = <span class="literal">YES</span>;</span><br><span class="line">          <span class="keyword">return</span> ;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;];</span><br></pre></td></tr></table></figure>
<p>如果是大量的数据保存操作可以通过dispatch_group_t创建并发线程来执行，在并发线程中加入串行任务，避免对主线程造成阻塞，来提高代码效率。示例如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 并发线程中串行执行</span></span><br><span class="line">dispatch_group_t group = dispatch_group_create();</span><br><span class="line"><span class="built_in">dispatch_queue_t</span> serialQueue = dispatch_queue_create(<span class="literal">NULL</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line"></span><br><span class="line">dispatch_group_async(group, serialQueue, ^&#123;</span><br><span class="line">  <span class="comment">// 先执行清理工作</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">dispatch_group_notify(group, serialQueue, ^&#123;</span><br><span class="line">  <span class="comment">// 保存数据</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="3，sqlite事务">3，sqlite事务</h4><p>与关系数据库进行交互的标准 SQLite 命令类似于 SQL。命令包括 CREATE、SELECT、INSERT、UPDATE、DELETE 和 DROP。这些命令基于它们的操作性质可分为以下几种：</p>
<ul>
<li>DDL - 数据定义语言(CREATE、ALTER、DROP)</li>
<li>DML - 数据操作语言(INSERT、UPDATE、DELETE)</li>
<li>DQL - 数据查询语言(SELECT)</li>
</ul>
<p>事务控制命令只与 DML 命令 INSERT、UPDATE 和 DELETE 一起使用。他们不能在创建表或删除表时使用，因为这些操作在数据库中是自动提交的。</p>
<p>SQLite中使用下面的命令来控制事务：BEGIN TRANSACTION：开始事务处理；COMMIT：保存更改，或者可以使用 END TRANSACTION 命令；ROLLBACK：回滚所做的更改。如果iOS的sqlite同时插入或者查询10000条数据，你该怎么办？减少数据库的开关操作，通过事务命令，把10000条语句封装成一个事务，只需一次COMMIT transaction即可完成。示例如下：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开始事务</span></span><br><span class="line">-(<span class="keyword">int</span>)beginService&#123;</span><br><span class="line">     <span class="keyword">char</span> *errmsg;</span><br><span class="line">     <span class="keyword">int</span> rc = sqlite3_exec(database, <span class="string">"BEGIN transaction"</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;errmsg);</span><br><span class="line">     <span class="keyword">return</span> rc;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 提交事务  </span></span><br><span class="line">-(<span class="keyword">int</span>)commitService&#123;</span><br><span class="line">     <span class="keyword">char</span> *errmsg;</span><br><span class="line">     <span class="keyword">int</span> rc = sqlite3_exec(database, <span class="string">"COMMIT transaction"</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;errmsg);</span><br><span class="line">     <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)execSQL</span><br><span class="line">&#123;</span><br><span class="line">   [database open]</span><br><span class="line">   [<span class="keyword">self</span> beginService];</span><br><span class="line">   <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">100000</span>; i++) &#123;</span><br><span class="line">          <span class="comment">//想要执行的sql语句</span></span><br><span class="line">       &#125;</span><br><span class="line">   [<span class="keyword">self</span> commitService]</span><br><span class="line">   [database close]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>FMDB对事务也有很好的支持，调用<code>- (void)inTransaction:(void (^)(FMDatabase *db, BOOL *rollback))block</code>方法即可实现，如果数据写入或读取失败，可以指定rollback参数来设置是否需要回滚，撤销本次操作。</p>
<h4 id="4，FMDB性能测试">4，FMDB性能测试</h4><p>设备环境iphone6s , xcode7.2 ，FMDB分别读写100、500、1000条数据，测试结果如下：</p>
<ul>
<li>100条数据：写入用时0.655秒，读取0.012秒</li>
<li>500条数据，写入用时2.112秒，读取0.043秒</li>
<li>1000条数据，写入用时6.2秒，读取0.036秒</li>
</ul>
<p>可见FMDB的读取性能还是很不错的，大量写入数据的时候比较耗时，可以通过切换至后台线程执行，保证主线程的任务可以立即响应。</p>
<p>参考：</p>
<p><a href="http://www.runoob.com/sqlite/sqlite-intro.html" target="_blank" rel="external">http://www.runoob.com/sqlite/sqlite-intro.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://dama2716588.github.io/2016/03/09/FMDB使用摘要/" data-id="cissvskgz0015lhb1hi68oycv" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/fmdb/">fmdb</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sqlite/">sqlite</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- disqus

-->

 
  
    <article id="post-Github上SSH key 的使用与管理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/23/Github上SSH key 的使用与管理/" class="article-date">
  <time datetime="2016-01-23T11:48:00.000Z" itemprop="datePublished">2016-01-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/github/">github</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/23/Github上SSH key 的使用与管理/">Github上SSH key 的使用与管理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>SSH 为 <a href="http://baike.baidu.com/view/2118359.htm" target="_blank" rel="external">Secure Shell</a> 的缩写，是相对<a href="http://baike.baidu.com/view/369.htm" target="_blank" rel="external">FTP</a>、POP和Telnet等明文传输数据来讲较为安全的一种协议。SSH传输的数据是经过压缩处理后的，传输速度快，从客户端来看，SSH提供两种级别的安全验证，<strong>第一种级别（基于口令的安全验证）</strong>，<strong>第二种级别（基于密匙的安全验证）</strong>。Github、Gitlab及Bitbuckut等代码托管平台都支持基于密匙的SSH来进行远程代码管理，下面以Github为例具体说下ssh key的创建与使用。</p>
<h4 id="1，SSH_key的生成">1，SSH key的生成</h4><p>abc@163.com 为Github的登录邮箱，通过以下命令即可创建一对公私钥 （公钥文件：~/.ssh/id_rsa.pub； 私钥文件：~/.ssh/id_rsa）:</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -<span class="keyword">C</span> <span class="string">"abc@163.com"</span></span><br></pre></td></tr></table></figure>
<p>然后会提示本地ssh key的保存路径，如果是单个创建，回车即可报错默认/Users/用户名/.ssh目录下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/Users/pandora/.ssh/id_rsa):</span><br></pre></td></tr></table></figure>
<p>接下来会提示是否需要帐号密码，可以为空，也可以任意指定（首次连接ssh是则会提示输入此密码）。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Enter passphrase (empty for no passphrase):</span><br></pre></td></tr></table></figure>
<p>至此，ssh key创建完毕。接下来只需将生成的ssh key保存至github即可，查看ssh key命令：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat ~<span class="regexp">/.ssh/id</span>_rsa.pub</span><br></pre></td></tr></table></figure>
<p>显示结果为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCohNI1KuNzVP7UlclbueAp/2Gxhbm0romfChDaqvF3dlMS0SS1HH1HQivG7G2J+hXwhV+V11x3LRKfyIkZy0iq6cccn4+Yan3zdWI12CfhzuHuVOQ7I2nLeDDF/CwqGrY/81r9HQpMNsPfnAHsoAT44M0QcTQORlapJYKIfz4LBT0ZXtGMnm8UeNR3t3RUL0RUZrBjgaeZIuihZjsxfpT3awOsLeTFJDld4Nv2ldw3sADQry0gT912r1IVBvpdmJ8SmQWDvjMggldhzHJoVq3ACM5jK+MSeVAUe11B3WlHDXaUIbHNyRhM+PyQ1FRgckVhz4NwJwPYSWJ5Zalm3GFl abc@163.com</span><br></pre></td></tr></table></figure>
<p>bcopy命令将生成的公钥拷贝至剪切板：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pbcopy &lt; ~<span class="regexp">/.ssh/id</span>_rsa.pub</span><br></pre></td></tr></table></figure>
<p>最后，打开github，找到设置页，在SSH keys中添加即可。</p>
<h4 id="2，链接测试SSH_key">2，链接测试SSH key</h4><p>运行ssh -T命令即可测试ssh key是否链接成功：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">ssh</span> -T git<span class="variable">@github</span>.com</span><br></pre></td></tr></table></figure>
<p>如成功，则提示：Hi user_abc! You’ve successfully authenticated, but GitHub does not provide shell access. user_abc就是该邮箱在Github注册的用户名。</p>
<p>如果测试连接不成功，可使用<code>ssh -vT git@github.com</code>命令查看详细输出，便于跟踪问题，执行结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">OpenSSH_6.<span class="number">9</span>p1, LibreSSL <span class="number">2.1</span>.<span class="number">8</span></span><br><span class="line">debug1: Reading configuration data /Users/pandora/.ssh/config</span><br><span class="line">debug1: /Users/pandora/.ssh/config line <span class="number">2</span>: Applying options <span class="keyword">for</span> github.com</span><br><span class="line">debug1: Reading configuration data /etc/ssh/ssh_config</span><br><span class="line">debug1: /etc/ssh/ssh_config line <span class="number">21</span>: Applying options <span class="keyword">for</span> *</span><br><span class="line">debug1: Connecting to github.com [<span class="number">192.30</span>.<span class="number">252.129</span>] port <span class="number">22</span>.</span><br><span class="line">debug1: Connection established.</span><br><span class="line">debug1: identity file /Users/pandora/.ssh/id_rsa_dama2716588 <span class="built_in">type</span> <span class="number">1</span></span><br><span class="line">debug1: key_load_public: No such file or directory</span><br><span class="line">debug1: identity file /Users/pandora/.ssh/id_rsa_dama2716588-cert <span class="built_in">type</span> -<span class="number">1</span></span><br><span class="line">debug1: Enabling compatibility mode <span class="keyword">for</span> protocol <span class="number">2.0</span></span><br><span class="line">debug1: Local version string SSH-<span class="number">2.0</span>-OpenSSH_6.<span class="number">9</span></span><br><span class="line">debug1: Remote protocol version <span class="number">2.0</span>, remote software version libssh-<span class="number">0.7</span>.<span class="number">0</span></span><br><span class="line">debug1: no match: libssh-<span class="number">0.7</span>.<span class="number">0</span></span><br><span class="line">debug1: Authenticating to github.com:<span class="number">22</span> as <span class="string">'git'</span></span><br><span class="line">debug1: SSH2_MSG_KEXINIT sent</span><br><span class="line">debug1: SSH2_MSG_KEXINIT received</span><br><span class="line">debug1: kex: server-&gt;client chacha20-poly1305@openssh.com &lt;implicit&gt; none</span><br><span class="line">debug1: kex: client-&gt;server chacha20-poly1305@openssh.com &lt;implicit&gt; none</span><br><span class="line">debug1: expecting SSH2_MSG_KEX_ECDH_REPLY</span><br><span class="line">debug1: Server host key: ssh-rsa SHA256:nThbg6kXUpJWGl7E1IGOCspRomTxdCARLviKw6E5SY8</span><br><span class="line">debug1: Host <span class="string">'github.com'</span> is known and matches the RSA host key.</span><br><span class="line">debug1: Found key <span class="keyword">in</span> /Users/pandora/.ssh/known_hosts:<span class="number">1</span></span><br><span class="line">debug1: SSH2_MSG_NEWKEYS sent</span><br><span class="line">debug1: expecting SSH2_MSG_NEWKEYS</span><br><span class="line">debug1: SSH2_MSG_NEWKEYS received</span><br><span class="line">debug1: Roaming not allowed by server</span><br><span class="line">debug1: SSH2_MSG_SERVICE_REQUEST sent</span><br><span class="line">debug1: SSH2_MSG_SERVICE_ACCEPT received</span><br><span class="line">debug1: Authentications that can <span class="built_in">continue</span>: publickey</span><br><span class="line">debug1: Next authentication method: publickey</span><br><span class="line">debug1: Offering RSA public key: /Users/pandora/.ssh/id_rsa_dama2716588</span><br><span class="line">debug1: Server accepts key: pkalg ssh-rsa blen <span class="number">279</span></span><br><span class="line">debug1: Authentication succeeded (publickey).</span><br><span class="line">Authenticated to github.com ([<span class="number">192.30</span>.<span class="number">252.129</span>]:<span class="number">22</span>).</span><br><span class="line">debug1: channel <span class="number">0</span>: new [client-session]</span><br><span class="line">debug1: Entering interactive session.</span><br><span class="line">debug1: Sending environment.</span><br><span class="line">debug1: Sending env LC_CTYPE = UTF-<span class="number">8</span></span><br><span class="line">debug1: client_input_channel_req: channel <span class="number">0</span> rtype <span class="built_in">exit</span>-status reply <span class="number">0</span></span><br><span class="line">Hi dama2716588! You<span class="string">'ve successfully authenticated, but GitHub does not provide shell access.</span><br><span class="line">debug1: channel 0: free: client-session, nchannels 1</span><br><span class="line">Transferred: sent 3244, received 1776 bytes, in 2.0 seconds</span><br><span class="line">Bytes per second: sent 1650.3, received 903.5</span><br><span class="line">debug1: Exit status 1</span></span><br></pre></td></tr></table></figure>
<h4 id="3，配置管理SSH_key">3，配置管理SSH key</h4><p>当本地存储使用多个ssh key时，需要通过config文件（/Users/用户名/.ssh/config）来切换默认账户，ssh config文件常用配置如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Default github user(dama2716588@126.com)  默认配置，一般可以省略</span></span><br><span class="line">Host github.com</span><br><span class="line">Hostname github.com</span><br><span class="line">User git</span><br><span class="line">Identityfile ~/.ssh/id_rsa_dama2716588</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 user(dama2716588@163.com)</span></span><br><span class="line">Host github.com</span><br><span class="line">HostName github.com</span><br><span class="line">User git</span><br><span class="line">Identityfile ~/.ssh/id_rsa_pandorago</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 user(mayulong01@baidu.com)</span></span><br><span class="line">gitlab.com 对应配置 </span><br><span class="line">Host gitlab.com</span><br><span class="line">HostName gitlab.com</span><br><span class="line">User mayulong01</span><br><span class="line">Identityfile ~/.ssh/id_rsa_gitlab_mayulong01</span><br></pre></td></tr></table></figure>
<p>Host： “personal.github.com”是一个”别名”，可以随意命名, 像github-PERSONAL这样的命名也可以；</p>
<p>HostName：比如我工作的git仓储地址是ssh://g@gitlab.baidu.com/abc.git, 那么我的HostName就要填”baidu.com”；</p>
<p>IdentityFile： 所使用的公钥文件;</p>
<p>参考链接：</p>
<p><a href="https://help.github.com/articles/generating-ssh-keys/" target="_blank" rel="external">https://help.github.com/articles/generating-ssh-keys/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://dama2716588.github.io/2016/01/23/Github上SSH key 的使用与管理/" data-id="cissvskgu000zlhb1zgv4pijp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/github/">github</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ssh/">ssh</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- disqus

-->

 
  
    <article id="post-聊一聊iOS后台任务" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/13/聊一聊iOS后台任务/" class="article-date">
  <time datetime="2016-01-13T12:43:00.000Z" itemprop="datePublished">2016-01-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/13/聊一聊iOS后台任务/">聊一聊iOS后台任务</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>iOS开发的过程中常常会有按下home键盘，进入后台，但不希望当前任务立即停止的情况，比如保存数据，断开链接，继续下载文件等，接下来就简单聊下iOS的后台任务。</p>
<h4 id="一，后台任务的分类">一，后台任务的分类</h4><p><strong>程序的5个状态和对应的AppDelegate的7个方法</strong> ：</p>
<ul>
<li>Not Running, 未运行</li>
<li>Inactive,  非活动</li>
<li>Active, 活动</li>
<li>Background, 后台</li>
<li>Suspend, 挂起</li>
</ul>
<p>对应的方法分别是：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 进程启动但还没完成初始化，这个方法是iOS6之后才有的</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application willFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions</span><br><span class="line"></span><br><span class="line"><span class="comment">// 进程启动基本完成      </span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application didFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions</span><br><span class="line"></span><br><span class="line"><span class="comment">// 应用程序将要入非活动状态执行，在此期间，应用程序不接收消息或事件</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)applicationWillResignActive:(<span class="built_in">UIApplication</span> *)application   </span><br><span class="line"></span><br><span class="line"><span class="comment">// 应用程序入活动状态，这个刚好跟上面那个方法相反</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)applicationDidBecomeActive:(<span class="built_in">UIApplication</span> *)application    </span><br><span class="line"></span><br><span class="line"><span class="comment">// 程序被推送到后台，如果要设置后台继续运行，则在这个函数里面设置即可</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)applicationDidEnterBackground:(<span class="built_in">UIApplication</span> *)application     </span><br><span class="line"></span><br><span class="line"><span class="comment">// 程序从后台将要回到前台</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)applicationWillEnterForeground:(<span class="built_in">UIApplication</span> *)application   </span><br><span class="line"></span><br><span class="line"><span class="comment">// 程序将要退出</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)applicationWillTerminate:(<span class="built_in">UIApplication</span> *)application</span><br></pre></td></tr></table></figure>
<p>在介绍iOS应用状态5种最基本的状态时，我们发现前台运行有两种状态，分别是Inactive和Active状态。大多数情况下，Inactive状态只是其它状态之间切换时短暂的停留状态，如前后台应用切换时，Inactive状态会在Active和Background之间短暂出现，比如App Switcher/回到原应用的操作等。</p>
<p>用户在按下home键后，app可做的事情有很多，比如听歌、打电话、下载电影、更新数据、定时任务等，可以大致分为两类，注册任务（耗时长）和非注册任务（耗时较短）。</p>
<h4 id="二，非注册任务的运行">二，非注册任务的运行</h4><p>非注册任务一般耗时较短，多用来保存数据或延迟执行某一命令等，通过系统API即可实现。可以先看一段官方实例代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)applicationDidEnterBackground:(<span class="built_in">UIApplication</span> *)application</span><br><span class="line">&#123;</span><br><span class="line">    bgTask = [application beginBackgroundTaskWithName:<span class="string">@"MyTask"</span> expirationHandler:^&#123;</span><br><span class="line">        <span class="comment">// Clean up any unfinished task business by marking where you</span></span><br><span class="line">        <span class="comment">// stopped or ending the task outright.</span></span><br><span class="line">        [application endBackgroundTask:bgTask];</span><br><span class="line">        bgTask = <span class="built_in">UIBackgroundTaskInvalid</span>;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start the long-running task and return immediately.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>beginBackgroundTaskWithName:expirationHandler:</code>方法标识了一个后台任务的开始，并用过超时处理的回调来结束此任务。那么，超时时间具体是多少？可以通过UIApplication的只读属性backgroundTimeRemaining来获取当前后台任务执行的剩余时间，它不是具体的数字（我执行的时间大概160秒），而是iOS根据当前系统环境综合考量后估算出来的。然后执行expirationHandler回调完成一个后台任务的执行周期。</p>
<h4 id="三，注册任务的流程">三，注册任务的流程</h4><p>有些耗时较长的工作，则需要申请专门的权限来保证正常执行而不被挂起，只有少数几种类型被允许这个做。</p>
<ul>
<li>Apps that play audible content to the user while in the background, such as a music player app</li>
<li>Apps that record audio content while in the background</li>
<li>Apps that keep users informed of their location at all times, such as a navigation app</li>
<li>Apps that support Voice over Internet Protocol (VoIP)</li>
<li>Apps that need to download and process new content regularly</li>
<li>Apps that receive regular updates from external accessories</li>
</ul>
<p>申请使用以上场景的后台权限需要在Xcode-&gt;Capabilities-&gt;Background Mode中配置，如下图所示：</p>
<p><img src="http://7xkptx.com1.z0.glb.clouddn.com/234f23g43g343.png" alt=""></p>
<p>勾选所需的模式后，会自动在app的info.plist文件中添加Required background modes一项，包含了所勾选的后台运行模式。如下所示：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;key&gt;UIBackgroundModes&lt;/key&gt;</span><br><span class="line">    &lt;array&gt;</span><br><span class="line">		&lt;string&gt;fetch&lt;/string&gt;</span><br><span class="line">		&lt;string&gt;voip&lt;/string&gt;</span><br><span class="line">	&lt;/array&gt;</span><br></pre></td></tr></table></figure>
<p>以Background Fetch为例，具体说下任务流程。</p>
<p>首先需要在Xcode Capabilities 中开启Background fetch选项，在<code>didFinishLaunchingWithOptions</code>中设置下获取的时间间隔：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="built_in">UIApplication</span> sharedApplication] setMinimumBackgroundFetchInterval:<span class="built_in">UIApplicationBackgroundFetchIntervalMinimum</span>];</span><br></pre></td></tr></table></figure>
<p>如果不对最小后台获取间隔进行设定的话，系统将使用默值<code>UIApplicationBackgroundFetchIntervalNever</code>，也就是永远不进行后台获取。而最小的时间间隔则有系统根据电量、网络状态、用户使用习惯等综合考量后来设定一定的差值，执行fetch任务，具体代码如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//File: YourAppDelegate.m</span></span><br><span class="line">-(<span class="keyword">void</span>)application:(<span class="built_in">UIApplication</span> *)application performFetchWithCompletionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">UIBackgroundFetchResult</span>))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UINavigationController</span> *navigationController = (<span class="built_in">UINavigationController</span>*)<span class="keyword">self</span><span class="variable">.window</span><span class="variable">.rootViewController</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">id</span> fetchViewController = navigationController<span class="variable">.topViewController</span>;</span><br><span class="line">    <span class="keyword">if</span> ([fetchViewController respondsToSelector:<span class="keyword">@selector</span>(fetchDataResult:)]) &#123;</span><br><span class="line">        [fetchViewController fetchDataResult:^(<span class="built_in">NSError</span> *error, <span class="built_in">NSArray</span> *results)&#123;</span><br><span class="line">            <span class="keyword">if</span> (!error) &#123;</span><br><span class="line">                <span class="keyword">if</span> (results<span class="variable">.count</span> != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//Update UI with results.</span></span><br><span class="line">                    <span class="comment">//Tell system all done.</span></span><br><span class="line">                    completionHandler(<span class="built_in">UIBackgroundFetchResultNewData</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    completionHandler(<span class="built_in">UIBackgroundFetchResultNoData</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                completionHandler(<span class="built_in">UIBackgroundFetchResultFailed</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        completionHandler(<span class="built_in">UIBackgroundFetchResultFailed</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与fetch类型的是，后台任务同样可以满足远程通知唤醒app执行某一进程，结束后以本地通知的方式提醒用户，以静默、智能的方式带给用户使用上的绝佳体验，相似的场景还有后台电影、音乐的下载等，在此不多做介绍。</p>
<h4 id="四，后台任务的注意事项">四，后台任务的注意事项</h4><h5 id="1，关于OpenGL_ES">1，关于OpenGL ES</h5><p>有些基于位置的app需要后台定时更新用户的当前位置，导致未知崩溃。原因就是Location update类型的后台任务在更新位置时，需要重新绘制MKMapView，调用了OpenGL ES，而OpenGL ES必须在程序Inactive以前关闭，不然会crash。如<a href="https://developer.apple.com/library/ios/documentation/3DDrawing/Conceptual/OpenGLES_ProgrammingGuide/ImplementingaMultitasking-awareOpenGLESApplication/ImplementingaMultitasking-awareOpenGLESApplication.html" target="_blank" rel="external">官方文档</a>描述：To summarize, your app needs to call the <code>glFinish</code> function to ensure that all previously submitted commands are drained from the command buffer and are executed by OpenGL ES. After it moves into the background, you must avoid all use of OpenGL ES until it moves back into the foreground.</p>
<p>可以在更新位置之前做一下app状态的检测：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( (appState != <span class="built_in">UIApplicationStateBackground</span>) &amp;&amp; (appState != <span class="built_in">UIApplicationStateInactive</span>)) &#123;</span><br><span class="line">     <span class="comment">// update location</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2，关于CAAnimation动画">2，关于CAAnimation动画</h5><p><img src="http://7xkptx.com1.z0.glb.clouddn.com/ca_architecture_2x.png" alt=""><br>OpenGL提供了Core Animation的基础，它是底层的C接口，直接和iPhone，iPad的硬件通信，极少地抽象出来的方法。当app进入background模式时，所有基于Core Animation 的动画将自动停止，这是因为动画的渲染需要调用Open GL或者Core Graphics来实现UIKit层的变动，然后在applicationWillEnterForeground的时候重新启动即可。</p>
<p>参考：</p>
<p><a href="http://onevcat.com/2013/08/ios7-background-multitask/" target="_blank" rel="external">http://onevcat.com/2013/08/ios7-background-multitask/</a></p>
<p><a href="https://developer.apple.com/library/ios/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/BackgroundExecution/BackgroundExecution.html" target="_blank" rel="external">https://developer.apple.com/library/ios/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/BackgroundExecution/BackgroundExecution.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://dama2716588.github.io/2016/01/13/聊一聊iOS后台任务/" data-id="cissvskgd0007lhb1rp448lzu" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/background/">background</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- disqus

-->

 
  
    <article id="post- iOS面试总结" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/24/ iOS面试总结/" class="article-date">
  <time datetime="2015-12-24T10:14:00.000Z" itemprop="datePublished">2015-12-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/24/ iOS面试总结/">iOS面试总结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>写在前面：iOS开发者水平良莠不齐，个人比较看中知识的全面性、编码规范性及学习能力，最近在面试iOS开发有些心得想和大家分享，整理如下：</p>
<h3 id="一，基础篇">一，基础篇</h3><h4 id="1，关键字">1，关键字</h4><p><code>strong</code> 该属性值对应 <em>_strong 关键字，即该属性所声明的变量将成为对象的持有者；</em></p>
<p><code>weak</code> 该属性对应 <strong>weak 关键字，与 </strong>weak 定义的变量一致，该属性所声明的变量将没有对象的所有权，并且当对象被破弃之后，对象将被自动赋值nil，delegate 和 Outlet 应该用 weak 属性来声明；</p>
<p><code>copy</code> 与 strong 的区别是声明变量是拷贝对象的持有者；</p>
<p><code>assign</code> 一般Scalar Varible用该属性声明，比如,int, BOOL；</p>
<p><code>static</code> 类全局变量，只是在编译时候进行初始化，对于static变量，无论是定义在方法体里面 还是在方法体外面其作用域都一样；</p>
<p><code>extern</code> extern的原理很简单，就是告诉编译器：“你现在编译的文件中，有一个变量虽然没有在本文件中定义，但是它是在别的文件中定义的全局变量，你要放行！”，比如 <code>extern NSString *aaa</code>;</p>
<p><code>const</code> </p>
<ul>
<li>const把对象转换为一个常量，不可修改，比如<code>const int bufSize = 512</code>；</li>
<li>const 对象默认为当前文件的局部变量，在全局作用域声明的const变量是定义该对象的文件的局部变量，不能被其它文件访问，可以加extern解决；</li>
</ul>
<p><code>synchronised</code> 通过对一段代码的使用进行加锁。其他试图执行该段代码的线程都会被阻塞，直到加锁线程退出执行该段被保护的代码段，也就是说<code>@synchronized()</code>代码块中的最后一条语句已经被执行完毕的时候；</p>
<h4 id="2，应用程序的状态">2，应用程序的状态</h4><p><img src="http://7xkptx.com1.z0.glb.clouddn.com/1348823833_6296.png" alt=""></p>
<p>主要考察对app当前状态及生命周期的了解程度。具体如下：</p>
<ul>
<li><code>application:willFinishLaunchingWithOptions:</code> - 这个方法是你在启动时的第一次机会来执行代码</li>
<li><code>application:didFinishLaunchingWithOptions:</code> - 这个方法允许你在显示app给用户之前执行最后的初始化操作</li>
<li><code>applicationDidBecomeActive:</code> - app已经切换到active状态后需要执行的操作</li>
<li><code>applicationWillResignActive:</code> - app将要从前台切换到后台时需要执行的操作</li>
<li><code>applicationDidEnterBackground:</code> - app已经进入后台后需要执行的操作</li>
<li><code>applicationWillEnterForeground:</code> - app将要从后台切换到前台需要执行的操作，但app还不是active状态</li>
<li><code>applicationWillTerminate:</code> - app将要结束时需要执行的操作</li>
</ul>
<h4 id="3，viewController的生命周期">3，<strong>viewController的生命周期</strong></h4><p><strong>单个</strong>：</p>
<ul>
<li>initWithCoder:(NSCoder *)aDecoder：（如果使用storyboard或者xib）    </li>
<li>loadView：加载view    </li>
<li>viewDidLoad：view加载完毕    </li>
<li>viewWillAppear：控制器的view将要显示    </li>
<li>viewWillLayoutSubviews：控制器的view将要布局子控件    </li>
<li>viewDidLayoutSubviews：控制器的view布局子控件完成<br>这期间系统可能会多次调用viewWillLayoutSubviews、viewDidLayoutSubviews 俩个方法  </li>
<li>viewDidAppear:控制器的view完全显示    </li>
<li>viewWillDisappear：控制器的view即将消失的时候<br>这期间系统也会调用viewWillLayoutSubviews 、viewDidLayoutSubviews 两个方法    </li>
<li>viewDidDisappear：控制器的view完全消失的时候</li>
</ul>
<p><strong>多个跳转</strong>：</p>
<ul>
<li>当我们点击push的时候首先会加载下一个界面然后才会调用界面的消失方法</li>
<li>initWithCoder:(NSCoder *)aDecoder：<code>ViewController2</code> (如果用xib创建的情况下）</li>
<li>loadView：<code>ViewController2</code></li>
<li>viewDidLoad：<code>ViewController2</code></li>
<li>viewWillDisappear：<strong>ViewController1</strong> 将要消失</li>
<li>viewWillAppear：<code>ViewController2</code> 将要出现</li>
<li>viewWillLayoutSubviews <code>ViewController2</code></li>
<li>viewDidLayoutSubviews <code>ViewController2</code></li>
<li>viewWillLayoutSubviews:<strong>ViewController1</strong></li>
<li>viewDidLayoutSubviews:<strong>ViewController1</strong></li>
<li>viewDidDisappear:<strong>ViewController1</strong> 完全消失</li>
<li>viewDidAppear:<code>ViewController2</code> 完全出现</li>
</ul>
<h4 id="4，OC设计模式">4，OC设计模式</h4><p>MVC、 delegate、 通知、 KVO、 KVC、 单例、 工厂模式等。</p>
<p>需要分别描述下各自的使用场景，比如通知适合一对多？iOS 代理为啥要用weak修饰? iOS系统单例有哪些？</p>
<h4 id="5，block和weak修饰符的区别">5，<strong>block和</strong>weak修饰符的区别</h4><ul>
<li>__block不管是ARC还是MRC模式下都可以使用，可以修饰对象，还可以修饰基本数据类型；</li>
<li>__weak只能在ARC模式下使用，也只能修饰对象，不能修饰基本数据类型；</li>
<li><strong>block对象可以在block中被重新赋值，</strong>weak不可以；</li>
</ul>
<h4 id="6，Objective-C中类别和类扩展的区别">6，Objective-C中类别和类扩展的区别</h4><p>Class extension常常被误解为一个匿名的category。它们的语法的确很相似。虽然都可以用来为一个现有的类添加方法和属性，但它们的目的和行为却是不同的，category和extensions的不同在于后者可以添加属性；另外类扩展添加的方法是必须要实现的；可以运行时给category通过<code>objc_setAssociatedObject</code>、<code>objc_getAssociatedObject</code>添加和读取属性。</p>
<h4 id="7，copy的使用">7，copy的使用</h4><p>用@property声明的NSString（或NSArray，NSDictionary）经常使用copy关键字，为什么？如果改用strong关键字，可能造成什么问题？</p>
<ul>
<li>因为父类指针可以指向子类对象,使用copy的目的是为了让本对象的属性不受外界影响,使用copy无论给我传入是一个可变对象还是不可对象,我本身持有的就是一个不可变的副本.</li>
<li>如果我们使用是strong,那么这个属性就有可能指向一个可变对象,如果这个可变对象在外部被修改了,那么会影响该属性.</li>
</ul>
<h4 id="8，LLVM_与_Clang">8，LLVM 与 Clang</h4><p>Clang 是一个 C++ 编写、基于 LLVM、发布于 LLVM BSD 许可证下的。C/C++/Objective C/Objective C++ 编译器，其目标（之一）就是超越 GCC。</p>
<p>Apple 使用 LLVM 在不支持全部 OpenGL 特性的 GPU (Intel 低端显卡) 上生成代码 (JIT)，令程序仍然能够正常运行。之后 LLVM 与 GCC 的集成过程引发了一些不快，GCC 系统庞大而笨重，而 Apple 大量使用的 Objective-C 在 GCC 中优先级很低。此外 GCC 作为一个纯粹的编译系统，与 IDE 配合很差。加之许可证方面的要求，Apple 无法使用修改版的 GCC 而闭源。于是 Apple 决定从零开始写 C family 的前端，也就是基于 LLVM 的 Clang 了。</p>
<p>Clang 的特性：</p>
<ul>
<li>快，通过编译 OS X 上几乎包含了所有 C 头文件的 carbon.h 的测试，包括预处理 (Preprocess)，语法 (lex)，解析 (parse)，语义分析 (Semantic Analysis)，抽象语法树生成 (Abstract Syntax Tree) 的时间，Clang 是 Apple GCC 4.0 的 2.5x 快。(2007-7-25)   </li>
<li>内存占用小：Clang 内存占用是源码的 130%，Apple GCC 则超过 10x。      </li>
<li>GCC 兼容性。   </li>
<li>设计清晰简单，容易理解，易于扩展增强。与代码基础古老的 GCC 相比，学习曲线平缓。   </li>
<li>基于库的模块化设计，易于 IDE 集成及其他用途的重用。</li>
</ul>
<h4 id="9，BAD_ACCESS如何调试">9，BAD_ACCESS如何调试</h4><p>BAD_ACCESS的出现是因为访问了野指针，比如对一个已经释放的对象执行了release、访问已经释放对象的成员变量或者发消息。</p>
<ul>
<li>重写object的respondsToSelector方法，现实出现EXEC_BAD_ACCESS前访问的最后一个object;</li>
<li>设置 Scheme Zombie 模式；</li>
<li>设置全局断点快速定位问题代码所在行；</li>
<li>Xcode 7 已经集成了BAD_ACCESS捕获功能：<strong>Address Sanitizer</strong>。 用法如下：在配置中勾选✅Enable Address Sanitizer；</li>
</ul>
<h3 id="二，实战篇">二，实战篇</h3><h4 id="10，以下代码运行结果如何?">10，以下代码运行结果如何?</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"1"</span>);</span><br><span class="line">    <span class="built_in">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"2"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"3"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：死锁</p>
<p>原因：</p>
<ul>
<li>dispatch_sync在等待block语句执行完成，而block语句需要在主线程里执行，所以dispatch_sync如果在主线程调用就会造成死锁；</li>
<li>dispatch_sync是同步的，本身就会阻塞当前线程，也即主线程。而又往主线程里塞进去一个block，所以就会发生死锁；</li>
<li>MainThread等待dispatch_sync，dispatch_sync等待block，block等待 mainquen, mainquen等待MainThread，而MainThread等待dispatch_sync。这样就形成了一个死循环；</li>
</ul>
<h4 id="11，HitTest方法">11，HitTest方法</h4><p><img src="http://7xkptx.com1.z0.glb.clouddn.com/d43g45h47j.png" alt=""></p>
<p>场景：</p>
<p>View A位于上方，View B位于下方。View A上有Button 2 ，View B上有Button 1，如何穿透View A ，点击让Button 2响应？</p>
<p><code>-(UIView *)hitTest:(CGPoint)point withEvent:(UIEvent *)event</code></p>
<ul>
<li>我们都知道，一个屏幕事件由响应链一步步传下去。这个函数返回的view就是可以让你决定在这个point的事件，你用来接收事件的view。当然，如果这个point不在你的view的范围，返回nil；</li>
<li>如果hitTest返回的view不为空，则会把hitTest返回的view作为第一响应者</li>
<li>如果hitTest返回的view为空，调用次序是从subview top到bottom，包括view本身，知道找到响应者为止。</li>
</ul>
<p>代码如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">View A:</span><br><span class="line">-(<span class="keyword">id</span>)hitTest:(<span class="built_in">CGPoint</span>)point withEvent:(<span class="built_in">UIEvent</span> *)event</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UIView</span> *hitView = [<span class="keyword">super</span> hitTest:point withEvent:event];</span><br><span class="line">    <span class="keyword">if</span> (hitView == <span class="keyword">self</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> hitView;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">View B:</span><br><span class="line">- (<span class="built_in">UIView</span> *)hitTest:(<span class="built_in">CGPoint</span>)point withEvent:(<span class="built_in">UIEvent</span> *)event</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 当touch point是在self.buttonFirst上，则hitTest返回self.buttonFirst</span></span><br><span class="line">    <span class="built_in">CGPoint</span> btnPointInA = [<span class="keyword">self</span><span class="variable">.buttonFirst</span> convertPoint:point fromView:<span class="keyword">self</span>];</span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span><span class="variable">.buttonFirst</span> pointInside:btnPointInA withEvent:event]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span><span class="variable">.buttonFirst</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 否则，返回默认处理</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> hitTest:point withEvent:event];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="12，GCD同步">12，GCD同步</h4><p>如何用GCD同步若干个异步调用？（如根据若干个url异步加载多张图片，然后在都下载完成后合成一张整图）</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line">dispatch_group_t group = dispatch_group_create();</span><br><span class="line">dispatch_group_async(group, queue, ^&#123; <span class="comment">/*加载图片1 */</span> &#125;);</span><br><span class="line">dispatch_group_async(group, queue, ^&#123; <span class="comment">/*加载图片2 */</span> &#125;);</span><br><span class="line">dispatch_group_async(group, queue, ^&#123; <span class="comment">/*加载图片3 */</span> &#125;); </span><br><span class="line">dispatch_group_notify(group, dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="comment">// 合并图片</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="13，NSOperation的特点">13，NSOperation的特点</h4><p><strong>依赖：</strong>顾名思义，第一个方法用于添加依赖，第二个方法则用于移除依赖。需要特别注意的是，用<code>addDependency:</code>方法添加的依赖关系是单向的，比如<code>[A addDependency:B];</code>，表示 A 依赖 B，B 并不依赖 A ；</p>
<p><strong>暂停：</strong>如果我们想要暂停和恢复执行 operation queue 中的 operation ，可以通过调用 operation queue 的 setSuspended: 方法来实现这个目的。不过需要注意的是，暂停执行 operation queue 并不能使正在执行的 operation 暂停执行，而只是简单地暂停调度新的 operation 。另外，我们<strong>并不能单独地暂停执行一个 operation</strong> ，除非直接 cancel 掉；</p>
<p><strong>优先级：</strong> 我们只能够在执行一个 operation 或将其添加到 operation queue 前，通过 operation 的 <code>setThreadPriority:</code> 方法来修改它的线程优先级。当 operation 开始执行时，NSOperation 类中默认的 <code>start</code> 方法会使用我们指定的值来修改当前线程的优先级。另外，我们指定的这个线程优先级只会影响 <code>main</code> 方法执行时所在线程的优先级。所有其它的代码，包括 operation 的 completion block 所在的线程会一直以默认的线程优先级执行。因此，当我们自定义一个并发的 operation 类时，我们也需要在 <code>start</code> 方法中根据指定的值自行修改线程的优先级。</p>
<h4 id="14,_UITextView代理方法的使用">14, UITextView代理方法的使用</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)textViewShouldBeginEditing:(<span class="built_in">UITextView</span> *)textView;</span><br><span class="line">- (<span class="built_in">BOOL</span>)textViewShouldEndEditing:(<span class="built_in">UITextView</span> *)textView;</span><br><span class="line">- (<span class="keyword">void</span>)textViewDidBeginEditing:(<span class="built_in">UITextView</span> *)textView;</span><br><span class="line">- (<span class="keyword">void</span>)textViewDidEndEditing:(<span class="built_in">UITextView</span> *)textView;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)textView:(<span class="built_in">UITextView</span> *)textView shouldChangeTextInRange:(<span class="built_in">NSRange</span>)range replacementText:(<span class="built_in">NSString</span> *)text;</span><br><span class="line">- (<span class="keyword">void</span>)textViewDidChange:(<span class="built_in">UITextView</span> *)textView;</span><br><span class="line">- (<span class="keyword">void</span>)textViewDidChangeSelection:(<span class="built_in">UITextView</span> *)textView;</span><br></pre></td></tr></table></figure>
<h4 id="15，如何把Model转换为字典">15，如何把Model转换为字典</h4><p>通过runtime的方式：</p>
<ul>
<li><p>首先，可以通过<code>class_copyPropertyList</code> 和 <code>protocol_copyPropertyList</code>方法来获取类的属性；  </p>
</li>
<li><p>比如获取某个类（obj）的属性列表：  </p>
</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> propsCount;</span><br><span class="line">objc_property_t *props = class_copyPropertyList([obj class], &amp;propsCount);</span><br></pre></td></tr></table></figure>
<ul>
<li>通过property_getName方法就可以得到某个类属性的名字了</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> propsCount;</span><br><span class="line">objc_property_t *props = class_copyPropertyList([obj class], &amp;propsCount);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; propsCount; i++)&#123;    </span><br><span class="line">  objc_property_t prop = props[i];    </span><br><span class="line">  <span class="built_in">NSString</span> *propName = [<span class="built_in">NSString</span> stringWithUTF8String:property_getName(prop)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>得到类属性的名称后，就可以知道该属性对应的类型了，如果是Object-C class，直接判断数据类型即可，比如NSString、NSArray、NSDictionary等。如果该属性的值对应的是派生类，则需要回到上一步重新解析，直到遍历完为止</li>
</ul>
<h4 id="16，常用的SVN/Git操作">16，常用的SVN/Git操作</h4><ul>
<li><p>SVN 分支与tag  </p>
<p><a href="https://www.baidu.com/s?wd=SVN&amp;tn=44039180_cpr&amp;fenlei=mv6quAkxTZn0IZRqIHckPjm4nH00T1Y3PA7bP1mvrj99uH61rHT10ZwV5Hcvrjm3rH6sPfKWUMw85HfYnjn4nH6sgvPsT6K1TL0qnfK1TL0z5HD0IgF_5y9YIZ0lQzqlpA-bmyt8mh7GuZR8mvqVQL7dugPYpyq8Q1n1Pjc1nWRvPs" target="_blank" rel="external">SVN</a>官方推荐在一个版本库的根目录下先建立trunk、branches、tags这三个文件夹，其中trunk是开发主干，存放日常开发的内容；branches存放各分支的内容，比如为不同客户定制的不同版本；tags存放某个版本状态的标签，比如验收测试版、1.0.3版等。tags中的内容是存放不再修改的，tags通常只给管理员开放写权限。</p>
</li>
<li><p>SVN 回滚  </p>
<p>1). 改动没有被提交:直接svn revert something就行了；当something为目录时，需要加上参数-R(Recursive,递归)，否则只会将something这个目录的改动。   </p>
<p>2). 改动已经被提交:可以使用svn diff -r HEAD:2500 [something]，此处的something可以是文件、目录或整个项目。如果需要回滚到版本号2500：</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">svn merge -r HEAD:<span class="number">2500</span> something</span><br></pre></td></tr></table></figure>
<h4 id="17，APNS_、IAP、itms-services协议等">17，APNS 、IAP、itms-<em>services</em>协议等</h4><ul>
<li>询问关于推送、应用内付费以及企业帐号发布等知识；</li>
<li>对AppFlyer、Adhoc、iTunes connect等了解使用情况。</li>
</ul>
<h4 id="18，算法题">18，算法题</h4><p>1). 四个人夜间要过一座桥，每人走路速度不一样，过桥需要时间分别是1，2，5，10分钟。现在只有一只手电筒在过桥时必须带，同时只能两人过，如何安排能够让四人最快速度过桥？</p>
<p>2). 25匹马赛跑，每次只能跑5匹，最快能赛几次找出跑得最快的3匹马？</p>
<h4 id="19，编码规范">19，编码规范</h4><p>不规范：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">    UserSex_Man,</span><br><span class="line">    UserSex_Woman,</span><br><span class="line">&#125;UserSex;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">testA</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="keyword">int</span> age;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) UserSex sex;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">id</span>)initUserModelWithUserName: (<span class="built_in">NSString</span>*)name withAge:(<span class="keyword">int</span>)age;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)doLogIn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>修改后：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, TSTUserSexType) &#123;</span><br><span class="line">    TSTUserSexTypeMan,</span><br><span class="line">    TSTUserSexTypeWoman,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">testA</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span>       *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span> ,<span class="keyword">assign</span>) <span class="keyword">int</span>            age;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) TSTUserSexType sex;</span><br><span class="line"></span><br><span class="line">- (instancetype)initUserModelWithUserName:(<span class="built_in">NSString</span>*)name withUserAge:(<span class="keyword">int</span>)age;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)doLoginWithSuccess:(<span class="keyword">void</span>(^)(<span class="keyword">id</span> response))success</span><br><span class="line">                   failure:(<span class="keyword">void</span>(^)(<span class="built_in">NSError</span> *error))failure;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<h3 id="三、高级篇">三、高级篇</h3><h4 id="20，Autorelease对象什么时候释放？">20，Autorelease对象什么时候释放？</h4><p>对于每一个Runloop， 系统会隐式创建一个Autorelease pool，这样所有的release pool会构成一个象CallStack一样的一个栈式结构，在每一个Runloop结束时，当前栈顶的Autorelease pool会被销毁，这样这个pool里的每个Object会被release。那什么是一个Runloop呢？ 一个UI事件，Timer call， delegate call， 都会是一个新的Runloop。</p>
<p>Autorelease对象是在当前的runloop迭代结束时释放的，而它能够释放的原因是系统在每个runloop迭代中都加入了自动释放池Push和Pop。</p>
<h4 id="21，深入理解runloop">21，深入理解runloop</h4><p>一般来讲，一个线程一次只能执行一个任务，执行完成后线程就会退出。如果我们需要一个机制，让线程能随时处理事件但并不退出，这种模型通常被称作 <a href="http://en.wikipedia.org/wiki/Event_loop" target="_blank" rel="external">Event Loop</a>。 Event Loop 在很多系统和框架里都有实现，比如 Node.js 的事件处理，比如 Windows 程序的消息循环，再比如 OSX/iOS 里的 RunLoop。实现这种模型的关键点在于：如何管理事件/消息，如何让线程在没有处理消息时休眠以避免资源占用、在有消息到来时立刻被唤醒。</p>
<p>RunLoop 实际上就是一个对象，这个对象管理了其需要处理的事件和消息，并提供了一个入口函数来执行上面 Event Loop 的逻辑。线程执行了这个函数后，就会一直处于这个函数内部 “接受消息-&gt;等待-&gt;处理” 的循环中，直到这个循环结束（比如传入 quit 的消息），函数返回。</p>
<p>OSX/iOS 系统中，提供了两个这样的对象：NSRunLoop 和 CFRunLoopRef。CFRunLoopRef 是在 CoreFoundation 框架内的，它提供了纯 C 函数的 API，所有这些 API 都是线程安全的。NSRunLoop 是基于 CFRunLoopRef 的封装，提供了面向对象的 API，但是这些 API 不是线程安全的。</p>
<p>问题一：NSURLConnection或NSStream指定RunLoop Mode的原因？<br>问题二：为何NSTimer在界面滚动时无响应？</p>
<p>参考回答一：<br>如果是在主线程，那么在滚动ScrollView或者TableView时，主线程的Run Loop会运行在UITrackingRunLoopMode模式，那么NSURLConnection或者NSStream的回调就无法运行，设置为NSRunLoopCommonModes，都可以保证NSURLConnection或者NSStream的回调可以被调用。<br>参考回答二：<br>当用户触摸界面时，主线程的run loop不再对timer事件进行处理。解决办法如下：<br><code>[[NSRunLoop currentRunLoop] addTimer:timer forMode:UITrackingRunLoopMode];</code></p>
<p>参考：<a href="http://blog.ibireme.com/2015/05/18/runloop/" target="_blank" rel="external">http://blog.ibireme.com/2015/05/18/runloop/</a></p>
<h4 id="22，runtime的理解与使用">22，runtime的理解与使用</h4><p>场景一：运行时给category添加属性，比如<code>objc_getAssociatedObject</code>、<code>objc_setAssociatedObject</code>；<br>场景二：动态获取类属性名称，比如<code>class_copyPropertyList</code>；<br>场景三：消息转发：<br>第一步：动态方法解析<br>对象在接收到未知的消息时，首先会调用所属类的类方法 +resolveInstanceMethod: 或者 +resolveClassMethod:，前者处理实例方法调用，后者处理类方法调用。我们可以它们里面用 class_addMethod() 加入异常处理的方法，不过前提是我们以及实现了处理方法。<br>第二步：备用接收者<br>如果在第一步还是无法处理消息，则 Runtime 会继续调以下方法：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (id)forwardingTargetForSelector:(SEL)aSelector</span><br></pre></td></tr></table></figure></p>
<p>如果一个对象实现了这个方法，并返回一个非 nil 的结果，则这个对象会作为消息的新接收者，且消息会被分发到这个对象。当然这个对象不能是 self 自身，否则就会出现无限循环。当然，如果我们没有指定相应的对象来处理 aSelector，则应该调用父类的实现来返回结果。<br>第三步：完整转发<br>如果第二步：备用接收者还是未能处理好消息，那么接下来只有启用完整的消息转发机制了，这时候会调用以下方法：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)forwardInvocation:(NSInvocation *)anInvocation</span><br></pre></td></tr></table></figure></p>
<p>运行时系统会在这一步给消息接收者最后一次机会将消息转发给其它对象。对象会创建一个表示消息的 NSInvocation 对象，把与尚未处理的消息有关的全部细节都封装在 anInvocation 中，包括：selector、目标(target)和参数。我们可以在 -forwardInvocation: 方法中选择将消息转发给其它对象。完整实例如下：<br>ViewController示例代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line"><span class="preprocessor">#pragma clang diagnostic push</span></span><br><span class="line"><span class="preprocessor">#pragma clang diagnostic ignored <span class="title">"-Wundeclared-selector"</span></span></span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(unknownMethod)];</span><br><span class="line">    [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(unknownMethod2)];</span><br><span class="line">    [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(unknownMethod3)];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *selectorString = <span class="built_in">NSStringFromSelector</span>(sel);</span><br><span class="line">    <span class="keyword">if</span> ([selectorString isEqualToString:<span class="string">@"unknownMethod"</span>]) &#123;</span><br><span class="line">        class_addMethod(<span class="keyword">self</span><span class="variable">.class</span>, <span class="keyword">@selector</span>(unknownMethod), (IMP) dealWithExceptionForUnknownMethod, <span class="string">"v@:"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveInstanceMethod:sel];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Deal with unknownMethod.</span></span><br><span class="line"><span class="keyword">void</span> dealWithExceptionForUnknownMethod(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@, %p"</span>, <span class="keyword">self</span>, _cmd); <span class="comment">// Print: &lt;ViewController: 0x7ff96be33e60&gt;, 0x1078259fc</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Deal with unknownMethod2.</span></span><br><span class="line">- (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *selectorString = <span class="built_in">NSStringFromSelector</span>(aSelector);</span><br><span class="line">    <span class="keyword">if</span> ([selectorString isEqualToString:<span class="string">@"unknownMethod2"</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> [[RuntimeMethodHelper alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> forwardingTargetForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Deal with unknownMethod3.</span></span><br><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="built_in">NSMethodSignature</span> *signature = [<span class="keyword">super</span> methodSignatureForSelector:aSelector];</span><br><span class="line">    <span class="keyword">if</span> (!signature) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([RuntimeMethodHelper instancesRespondToSelector:aSelector]) &#123;</span><br><span class="line">            signature = [RuntimeMethodHelper instanceMethodSignatureForSelector:aSelector];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> signature;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation &#123;</span><br><span class="line">    <span class="keyword">if</span> ([RuntimeMethodHelper instancesRespondToSelector:anInvocation<span class="variable">.selector</span>]) &#123;</span><br><span class="line">        [anInvocation invokeWithTarget:[[RuntimeMethodHelper alloc] init]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RuntimeMethodHelper示例代码：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*RuntimeMethodHelper.h*/</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">RuntimeMethodHelper</span> : <span class="title">NSObject</span></span></span><br><span class="line">- (<span class="keyword">void</span>)unknownMethod2;</span><br><span class="line">- (<span class="keyword">void</span>)unknownMethod3;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*RuntimeMethodHelper.m*/</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">RuntimeMethodHelper</span></span></span><br><span class="line">- (<span class="keyword">void</span>)unknownMethod2 &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@, %p"</span>, <span class="keyword">self</span>, _cmd); <span class="comment">// Print: &lt;RuntimeMethodHelper: 0x7fb61042f410&gt;, 0x10170d99a</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)unknownMethod3 &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@, %p"</span>, <span class="keyword">self</span>, _cmd); <span class="comment">// Print: &lt;RuntimeMethodHelper: 0x7f814b498ee0&gt;, 0x102d79929</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>场景四：动态创建类和对象，例如：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建类实例</span></span><br><span class="line"><span class="keyword">id</span> class_createInstance ( Class cls, size_t extraBytes );</span><br><span class="line"><span class="comment">// 在指定位置创建类实例</span></span><br><span class="line"><span class="keyword">id</span> objc_constructInstance ( Class cls, <span class="keyword">void</span> *bytes );</span><br><span class="line"><span class="comment">// 销毁类实例</span></span><br><span class="line"><span class="keyword">void</span> * objc_destructInstance ( <span class="keyword">id</span> obj );</span><br></pre></td></tr></table></figure></p>
<p>场景五：IOS中如何Hook消息？<br><code>class_replaceMethod</code>使用该函数可以在运行时动态替换某个类的函数实现，截获系统类的某个实例函数。</p>
<p>场景六：Method Swizzling<br>例如，我们想跟踪在程序中每一个view controller展示给用户的次数，在每个view controller的viewDidAppear中添加跟踪代码，但是这太过麻烦。这种情况下，我们就可以使用Method Swizzling。示例代码如下：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#import <span class="title">&lt;objc/runtime.h&gt;</span> </span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIViewController</span> (<span class="title">Tracking</span>) </span></span><br><span class="line"> </span><br><span class="line">+ (<span class="keyword">void</span>)load &#123; </span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken; </span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123; </span><br><span class="line">        Class aClass = [<span class="keyword">self</span> class]; </span><br><span class="line"> </span><br><span class="line">        SEL originalSelector = <span class="keyword">@selector</span>(viewWillAppear:); </span><br><span class="line">        SEL swizzledSelector = <span class="keyword">@selector</span>(xxx_viewWillAppear:); </span><br><span class="line"> </span><br><span class="line">        Method originalMethod = class_getInstanceMethod(aClass, originalSelector); </span><br><span class="line">        Method swizzledMethod = class_getInstanceMethod(aClass, swizzledSelector); </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// When swizzling a class method, use the following:</span></span><br><span class="line">        <span class="comment">// Class aClass = object_getClass((id)self);</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// Method originalMethod = class_getClassMethod(aClass, originalSelector);</span></span><br><span class="line">        <span class="comment">// Method swizzledMethod = class_getClassMethod(aClass, swizzledSelector);</span></span><br><span class="line"> </span><br><span class="line">        <span class="built_in">BOOL</span> didAddMethod = </span><br><span class="line">            class_addMethod(aClass, </span><br><span class="line">                originalSelector, </span><br><span class="line">                method_getImplementation(swizzledMethod), </span><br><span class="line">                method_getTypeEncoding(swizzledMethod)); </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (didAddMethod) &#123; </span><br><span class="line">            class_replaceMethod(aClass, </span><br><span class="line">                swizzledSelector, </span><br><span class="line">                method_getImplementation(originalMethod), </span><br><span class="line">                method_getTypeEncoding(originalMethod)); </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            method_exchangeImplementations(originalMethod, swizzledMethod); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125;); </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line"><span class="preprocessor">#pragma mark - Method Swizzling </span></span><br><span class="line"> </span><br><span class="line">- (<span class="keyword">void</span>)xxx_viewWillAppear:(<span class="built_in">BOOL</span>)animated &#123; </span><br><span class="line">    [<span class="keyword">self</span> xxx_viewWillAppear:animated]; </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"viewWillAppear: %@"</span>, <span class="keyword">self</span>); </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>关于load</p>
<ul>
<li>load会在类初始加载时调用，+initialize会在第一次调用类的类方法或实例方法之前被调用;</li>
<li>load能保证在类的初始化过程中被加载，并保证这种改变应用级别的行为的一致性;</li>
<li>initialize在其执行时不提供这种保证—事实上，如果在应用中没为给这个类发送消息，则它可能永远不会被调用;</li>
<li>Swizzling应该总是在dispatch_once中执行，确保代码只被执行一次。</li>
</ul>
<h4 id="23，lib库的编写与使用">23，lib库的编写与使用</h4><ul>
<li>如何保证lib库中category文件的正常读取？  </li>
<li>如何保证lib对armv7s的支持？<br>Build Setting -&gt; Architectures, 添加 $(ARCHS_STANDARD)和   armv7s</li>
<li>如何合并不同平台的lib库？</li>
<li>iOS 第三方库冲突的如何处理？可以对lib库内的文件修改重修打包吗 ？<br>实例，比如libHChatSDK.a中包含了JSONKit库，现有工程中同样包含了JSONKit库，这样在当前工程中加入libHChatSDK.a时会引起duplicate symbols for architecture armv7的编译错误，那么我们可以重新编辑libHChatSDK.a，删除JSONKit.o然后再打包合并即可，具体命令如下：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1,新建armv7s目录</span></span><br><span class="line">mkdir ~/desktop/armv7s</span><br><span class="line"><span class="comment"># 2,分离出armv7s平台</span></span><br><span class="line">lipo  libHChatSDK.a  -thin  armv7s  -output  libHChatSDK-armv7s.a</span><br><span class="line"><span class="comment"># 3,解压 libHChatSDK.a</span></span><br><span class="line"><span class="built_in">cd</span> armv7s &amp;&amp; ar xv libHChatSDK-armv7s.a</span><br><span class="line"><span class="comment"># 4,查看库中所包含的文件列表</span></span><br><span class="line">ar -t armv7/libHChatSDK-armv7s.a</span><br><span class="line"><span class="comment"># 5,找到JSONKit.o并删除</span></span><br><span class="line">rm JSONKit.o</span><br><span class="line"><span class="comment"># 6,重新打包libHChatSDK-armv7s.a</span></span><br><span class="line">ar rcs libHChatSDK-armv7s.a armv7s/*.o</span><br><span class="line"><span class="comment"># 7,重复第3步，确认JSONKit已经被删除</span></span><br><span class="line"><span class="comment"># 8,按照1-7分别生成armv7平台、arm64平台及模拟器使用的x86_64、i386平台</span></span><br><span class="line"><span class="comment"># 9,最后用lipo -c 命令合并各个平台即可</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>常用的lib命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用 lipo info 查看静态库支持的平台</span></span><br><span class="line">$ lipo libname.a -info</span><br><span class="line"><span class="comment"># 用 lipo remove 参数来删除平台</span></span><br><span class="line">lipo libname.a -remove x86_64 -output libname1.a</span><br><span class="line"><span class="comment"># 用 lipo create 将两个不同平台的库合并到一起</span></span><br><span class="line">$ lipo -create libname1.a libname2.a -output libname3.a</span><br><span class="line"><span class="comment"># 用 lipo thin 参数来分离平台</span></span><br><span class="line">lipo libname.a -thin armv7 -output armv7/libname-armv7.a</span><br></pre></td></tr></table></figure></p>
<h4 id="24，ARM64与ARMv7">24，ARM64与ARMv7</h4><p>Arm处理器，因为其低功耗和小尺寸而闻名，几乎所有的手机处理器都基于arm，其在嵌入式系统中的应用非常广泛，它的性能在同等功耗产品中也很出色。</p>
<p>Armv6、armv7、armv7s、arm64都是arm处理器的指令集，所有指令集原则上都是向下兼容的，如iPhone4S的CPU默认指令集为armv7指令集，但它同时也兼容armv6指令集，只是使用armv6指令集时无法充分发挥其性能，即无法使用armv7指令集中的新特性，同理，iPhone5的处理器标配armv7s指令集，同时也支持armv7指令集，只是无法进行相关的性能优化，从而导致程序的执行效率没那么高。 </p>
<p>需要注意的是iOS模拟器没有运行arm指令集，编译运行的是x86指令集，所以，只有在iOS设备上，才会执行设备对应的arm指令集。</p>
<p>iOS设备与ARM平台分布如下图：</p>
<p><img src="http://7xkptx.com1.z0.glb.clouddn.com/armv7s.png" alt=""></p>
<h4 id="参考：">参考：</h4><p><a href="http://www.jianshu.com/p/2e7ae4457083" target="_blank" rel="external">http://www.jianshu.com/p/2e7ae4457083</a></p>
<p><a href="http://www.iswifting.com/2015/07/26/71/" target="_blank" rel="external">http://www.iswifting.com/2015/07/26/71/</a></p>
<p><a href="http://blog.leichunfeng.com/blog/2015/05/31/objective-c-autorelease-pool-implementation-principle/" target="_blank" rel="external">http://blog.leichunfeng.com/blog/2015/05/31/objective-c-autorelease-pool-implementation-principle/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://dama2716588.github.io/2015/12/24/ iOS面试总结/" data-id="cissvskfq0000lhb1tnp5fe7p" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>

<!-- disqus

-->

 
  
    <article id="post-几款mac小工具推荐" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/14/几款mac小工具推荐/" class="article-date">
  <time datetime="2015-12-14T09:30:00.000Z" itemprop="datePublished">2015-12-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/mac/">mac</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/14/几款mac小工具推荐/">几款mac小工具推荐</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="iTerm2">iTerm2</h3><p>Mac下的命令行工具五花八门，选择一款便捷的扩展性强的工具对工作效率提升十分重要。在此推荐<a href="https://www.iterm2.com/" target="_blank" rel="external">iTem2</a> + <a href="http://ohmyz.sh/" target="_blank" rel="external">oh-my-zsh</a>，Mac自带的shell工具Terminal是基于bash实现，而且zsh在兼容bash的基础上又提供了强大的扩展插件，二者方便切换，只需一条命令即可：exec bash（切换bash），exec zsh（切换zsh）。oh my zsh是一款<a href="https://github.com/robbyrussell/oh-my-zsh" target="_blank" rel="external">开源</a>的ZSH插件，可以方便的自定义主题，对SVN/GIT有很好的支持，有强大的<a href="https://github.com/robbyrussell/oh-my-zsh/tree/master/plugins" target="_blank" rel="external">开源开源插件</a>，如<a href="https://github.com/robbyrussell/oh-my-zsh/tree/master/plugins/autojump" target="_blank" rel="external">autojump</a>，<a href="https://github.com/robbyrussell/oh-my-zsh/tree/master/plugins/svn" target="_blank" rel="external">svn</a>等提供支持。附图如下：</p>
<p><img src="http://7xkptx.com1.z0.glb.clouddn.com/f334t443h56j76.png" alt=""></p>
<p>快捷键配置如下：</p>
<p><img src="http://7xkptx.com1.z0.glb.clouddn.com/96339610-C393-4D03-A7AF-BB1120C80B8A.png" alt=""></p>
<ul>
<li>设置Left option 为 +Esc，可以单词为单位左右移动光标：向后 Option + B(back) ; 向前 Option + F(front) </li>
<li>Option + Q 清除当前行</li>
<li>Command + K 清除当前面板</li>
<li>Option + P 上一个输入过的命令</li>
<li>Option + N 后一个输入过的命令</li>
<li>向上箭头 ：上一个执行过的命令</li>
<li>向下剪头 ：后一个执行过的命令</li>
<li>Control + A 光标最前</li>
<li>Control + E 光标最后</li>
</ul>
<h3 id="aTEXT"><a href="https://itunes.apple.com/us/app/atext/id488566438?mt=12" target="_blank" rel="external">aTEXT</a></h3><p>经常使用命令行的同学，有时不得不重复一些常用命令，比如代码的提交、更新，API的测试等，aText就是一款提供命令行或常用语句缩写的工具。</p>
<p><img src="http://7xkptx.com1.z0.glb.clouddn.com/Screen%20Shot%202015-12-14%20at%2016.39.17.png" alt=""></p>
<h3 id="Hexo"><a href="https://hexo.io/" target="_blank" rel="external">Hexo</a></h3><p>hero是一款极为方便的基于nodejs的静态博客工具，只需几行命令即可搞定，具体请参考<a href="https://hexo.io/" target="_blank" rel="external">这里</a>。hexo还支持一键发布到GitHub Pages, Heroku 或其他网站，另外官方推出诸多插件，比如<a href="https://github.com/jaredly/hexo-admin" target="_blank" rel="external">hexo-admin</a>后台管理可以方便的添加tag、分类等。</p>
<h3 id="其他">其他</h3><p>比如常用的markdown编辑器<a href="typora.io/">Typara</a>，效率工具<a href="https://pomotodo.com/" target="_blank" rel="external">番茄土豆</a>，以及<a href="https://pomotodo.com/" target="_blank" rel="external">奇妙清单</a>等对工作效率的提升也有很大帮助。更多请关注来自知乎的<a href="http://www.zhihu.com/question/20873070" target="_blank" rel="external">热门推荐</a>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://dama2716588.github.io/2015/12/14/几款mac小工具推荐/" data-id="cissvskgh000flhb1d0n0i889" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mac/">mac</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- disqus

-->

 
  
    <article id="post-常用的SVN命令小结" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/10/常用的SVN命令小结/" class="article-date">
  <time datetime="2015-11-10T12:06:00.000Z" itemprop="datePublished">2015-11-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/svn/">svn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/10/常用的SVN命令小结/">常用的SVN命令小结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="1，基础命令">1，基础命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">svn co repository_url // check out respoitory</span><br><span class="line">svn ci -m <span class="string">"your comments"</span> // commit files</span><br><span class="line">svn up repository_url // update files</span><br></pre></td></tr></table></figure>
<h3 id="2，branch_&amp;_tag">2，branch &amp; tag</h3><p>所谓打tag，要从<a href="https://www.baidu.com/s?wd=SVN&amp;tn=44039180_cpr&amp;fenlei=mv6quAkxTZn0IZRqIHckPjm4nH00T1Y3PA7bP1mvrj99uH61rHT10ZwV5Hcvrjm3rH6sPfKWUMw85HfYnjn4nH6sgvPsT6K1TL0qnfK1TL0z5HD0IgF_5y9YIZ0lQzqlpA-bmyt8mh7GuZR8mvqVQL7dugPYpyq8Q1n1Pjc1nWRvPs" target="_blank" rel="external">SVN</a>官方推荐的目录结构说起了。<a href="https://www.baidu.com/s?wd=SVN&amp;tn=44039180_cpr&amp;fenlei=mv6quAkxTZn0IZRqIHckPjm4nH00T1Y3PA7bP1mvrj99uH61rHT10ZwV5Hcvrjm3rH6sPfKWUMw85HfYnjn4nH6sgvPsT6K1TL0qnfK1TL0z5HD0IgF_5y9YIZ0lQzqlpA-bmyt8mh7GuZR8mvqVQL7dugPYpyq8Q1n1Pjc1nWRvPs" target="_blank" rel="external">SVN</a>官方推荐在一个版本库的根目录下先建立trunk、branches、tags这三个文件夹，其中trunk是开发主干，存放日常开发的内容；branches存放各分支的内容，比如为不同客户定制的不同版本；tags存放某个版本状态的标签，比如验收测试版、1.0.3版等。branhces和tags本质没有区别，都是通过<a href="https://www.baidu.com/s?wd=svn&amp;tn=44039180_cpr&amp;fenlei=mv6quAkxTZn0IZRqIHckPjm4nH00T1Y3PA7bP1mvrj99uH61rHT10ZwV5Hcvrjm3rH6sPfKWUMw85HfYnjn4nH6sgvPsT6K1TL0qnfK1TL0z5HD0IgF_5y9YIZ0lQzqlpA-bmyt8mh7GuZR8mvqVQL7dugPYpyq8Q1n1Pjc1nWRvPs" target="_blank" rel="external">svn</a> copy方式建立的，差异在于通常branches中的内容是需要继续修改或开发的，tags中的内容是存放不再修改的，这一般通过权限设置来解决，tags通常只给管理员开放写权限。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// 新建分支</span><br><span class="line">svn copy master_repository_url branch_repository_url -m <span class="string">"your comments"</span></span><br><span class="line"></span><br><span class="line">// 新建空白分支</span><br><span class="line">svn mkdir branch_repository_url</span><br><span class="line"></span><br><span class="line">// 删除分支</span><br><span class="line">svn rm branch_repository_url -m <span class="string">"your comments"</span></span><br><span class="line"></span><br><span class="line">// 新建tag</span><br><span class="line">svn copy master_repository_url tag_repository_url -m <span class="string">"your comments"</span></span><br><span class="line"></span><br><span class="line">// 删除tag</span><br><span class="line">svn rm tag_repository_url -m <span class="string">"your comments"</span></span><br><span class="line"></span><br><span class="line">// 查看branches</span><br><span class="line">svn ls ^/branches --verbose</span><br></pre></td></tr></table></figure>
<h3 id="3，回滚">3，回滚</h3><p>3-1），改动没有被提交</p>
<p>这种情况下，使用svn revert就能取消之前的修改。svn revert用法如下：当something为单个文件时，直接svn revert something就行了；当something为目录时，需要加上参数-R(Recursive,递归)，否则只会将something这个目录的改动。</p>
<p>3-2），改动已经被提交</p>
<p>这种情况下，用svn merge命令来进行回滚。先运行svn up保证拿到最新的版本，然后svn log查看并找到要回滚的版本号，如果想要更详细的了解情况，可以使用svn diff -r HEAD:2500 [something]，此处的something可以是文件、目录或整个项目。</p>
<p>如果需要回滚到版本号2500：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">svn merge -r HEAD:<span class="number">2500</span> something</span><br></pre></td></tr></table></figure>
<p>为了保险起见，再次确认回滚的结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">svn diff -r HEAD:<span class="number">2500</span> [something]</span><br></pre></td></tr></table></figure>
<p>发现无误，提交即可。</p>
<p>3-3），分支与主干的合并：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分支合到主干 cd trunk</span></span><br><span class="line">svn merge -r &lt;revision <span class="built_in">where</span> branch was cut&gt;:&lt;revision of trunk&gt; svn://branch/path</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分支当前版本为4847，想把4825到4847间的改动merge到主干</span></span><br><span class="line"><span class="comment"># cd trunk</span></span><br><span class="line">svn merge -r <span class="number">4825</span>:<span class="number">4847</span> svn://branch/path</span><br><span class="line">svn ci -m <span class="string">"merge branch changes r4835:4847 into trunk"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主干合到分支 cd branch</span></span><br><span class="line"><span class="comment"># 在r23创建了一个分支，trunk版本号更新到了25，想把23-25之间的改动merge到分支</span></span><br><span class="line">svn merge -r <span class="number">23</span>:<span class="number">25</span> svn://trunk/path</span><br><span class="line">svn ci -m <span class="string">"merge trunk changes r23:25 into my branch"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cd trunk</span></span><br><span class="line"><span class="comment"># 查看当前Branch中已经有那些改动已经被合并到Trunk中</span></span><br><span class="line">svn mergeinfo svn://branch/path</span><br><span class="line"></span><br><span class="line"><span class="comment"># cd trunk</span></span><br><span class="line"><span class="comment"># 查看Branch中那些改动还未合并</span></span><br><span class="line">svn merginfo svn://branch/path --show-revs eligible</span><br></pre></td></tr></table></figure>
<p>3-4），merge分支B到分支A</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">step1: Checkout URL A</span><br><span class="line">       <span class="comment"># cd branch A</span></span><br><span class="line">step2: merge URL B to your working copy of A</span><br><span class="line">       svn merge -r <span class="number">10</span>:HEAD http://branch-b .</span><br><span class="line">step3: Commit A</span><br></pre></td></tr></table></figure>
<h3 id="4，冲突提示">4，冲突提示</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(p) postpone          暂时推后处理，我可能要和那个和我冲突的家伙商量一番</span><br><span class="line">(df) diff-full        把所有的修改列出来，比比看</span><br><span class="line">(e) edit              直接编辑冲突的文件</span><br><span class="line">(mc) mine-conflict    如果你很有自信可以只用你的修改，把别人的修改干掉</span><br><span class="line">(tc) theirs-conflict  底气不足，还是用别人修改的吧</span><br><span class="line">(s) show all options  显示其他可用的命令</span><br></pre></td></tr></table></figure>
<h3 id="5，svn符号">5，svn符号</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">U:表示从服务器收到文件更新了</span><br><span class="line">G:表示本地文件以及服务器文件都已更新,而且成功的合并了 </span><br><span class="line">其他的如下:</span><br><span class="line">A:表示有文件或者目录添加到工作目录</span><br><span class="line">R:表示文件或者目录被替换了.</span><br><span class="line">C:表示文件的本地修改和服务器修改发生冲突</span><br></pre></td></tr></table></figure>
<h3 id="6，patch">6，patch</h3><p>有时同事A做的修改需要同事B去Review，同事C去提交。使用patch工具可以很好的决代码传递。<br>6-1).生成patch:<br>同事 A 运行如下命令生成 patch:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">svn diff &gt; aaa.patch</span><br></pre></td></tr></table></figure></p>
<p>6-2).应用patch:<br>同事 B 运行如下命令应用 patch:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">patch –p0 &lt; aaa.patch</span><br></pre></td></tr></table></figure></p>
<p>6-3).去除patch，恢复旧版本<br>当他 review 完代码，想删除该 patch 时， 可运行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">patch -RE -p0 &lt; aaa.patch</span><br></pre></td></tr></table></figure></p>
<p>-p0，是“当前路径”<br>-p1，是“上一级路径”</p>
<p>参考：<a href="http://stereointeractive.com/blog/2009/02/17/svn-merge-trunk-changes-to-your-branch/" target="_blank" rel="external">http://stereointeractive.com/blog/2009/02/17/svn-merge-trunk-changes-to-your-branch/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://dama2716588.github.io/2015/11/10/常用的SVN命令小结/" data-id="cissvskgf000alhb17rupjc7d" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/svn/">svn</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- disqus

-->

 
  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/App-Store/">App Store</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/github/">github</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mac/">mac</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/svn/">svn</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/GCD/">GCD</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IAP/">IAP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OTA/">OTA</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Watch-OS/">Watch OS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/background/">background</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fmdb/">fmdb</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/">github</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ipa/">ipa</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mac/">mac</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sqlite/">sqlite</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssh/">ssh</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/svn/">svn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/推送/">推送</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/GCD/" style="font-size: 10px;">GCD</a> <a href="/tags/IAP/" style="font-size: 10px;">IAP</a> <a href="/tags/OTA/" style="font-size: 10px;">OTA</a> <a href="/tags/Watch-OS/" style="font-size: 10px;">Watch OS</a> <a href="/tags/background/" style="font-size: 10px;">background</a> <a href="/tags/fmdb/" style="font-size: 10px;">fmdb</a> <a href="/tags/github/" style="font-size: 20px;">github</a> <a href="/tags/ipa/" style="font-size: 10px;">ipa</a> <a href="/tags/mac/" style="font-size: 10px;">mac</a> <a href="/tags/sqlite/" style="font-size: 10px;">sqlite</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/svn/" style="font-size: 10px;">svn</a> <a href="/tags/推送/" style="font-size: 10px;">推送</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/09/07/逆向Appstore应用（二）/">逆向Appstore应用（二）</a>
          </li>
        
          <li>
            <a href="/2016/07/20/逆向Appstore应用（一）/">逆向Appstore应用（一）</a>
          </li>
        
          <li>
            <a href="/2016/04/06/一款Watch OS版微博/">一款Watch OS版微博</a>
          </li>
        
          <li>
            <a href="/2016/03/11/关于GCD的几个用例/">关于GCD的几个用例</a>
          </li>
        
          <li>
            <a href="/2016/03/09/FMDB使用摘要/">FMDB使用摘要</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Pandora<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>